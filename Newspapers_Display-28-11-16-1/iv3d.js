var iv={INV_MTLS:2,INV_VERSION:4,VIEW_TRANSITION:1,VIEW_UNDO:2,VIEW_INVALIDATE:4,VIEW_ANIM_SET:8,VIEW_ANIM_PLAY:16,R_SELECTION:4,R_Z_NOWRITE:16,R_Z_OFFSET:0x30000,R_CLIP: 0xc0000,FILTER_LINEAR:1,FILTER_MIPMAP:2,FILTER_BOX:3,createRequest:function(f,p){if(f==undefined)return null;var r=new XMLHttpRequest();r.open("GET",p?(p+f):f);return r;},anim:{},indexOf:function(a,b){var c=a.length;for(var i=0;i<c;i++){if(a[i]==b)return i;}return-1;},any:function(a,b){return(a==undefined)?b:a;}};glMatrixArrayType=typeof Float32Array!="undefined"?Float32Array:typeof WebGLFloatArray!="undefined"?WebGLFloatArray:Array;var vec3={};vec3.create=function(a){var b=new glMatrixArrayType(3);if(a){b[0]=a[0];b[1]=a[1];b[2]=a[2]}return b};vec3.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];return b};vec3.add=function(a,b,c){if(!c||a==c){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];return a}c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];return c};vec3.subtract=function(a,b,c){if(!c||a==c){a[0]-=b[0];a[1]-=b[1];a[2]-=b[2];return a}c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-b[2];return c};vec3.scale=function(a,b,c){if(!c||a==c){a[0]*=b;a[1]*=b;a[2]*=b;return a}c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;return c};vec3.normalize=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=Math.sqrt(c*c+d*d+e*e);if(g){if(g==1){b[0]=c;b[1]=d;b[2]=e;return b}}else{b[0]=0;b[1]=0;b[2]=0;return b}g=1/g;b[0]=c*g;b[1]=d*g;b[2]=e*g;return b};vec3.cross=function(a,b,c){c||(c=a);var d=a[0],e=a[1];a=a[2];var g=b[0],f=b[1];b=b[2];c[0]=e*b-a*f;c[1]=a*g-d*b;c[2]=d*f-e*g;return c};vec3.length=function(a){var b=a[0],c=a[1];a=a[2];return Math.sqrt(b*b+c*c+a*a)};vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};vec3.subtractN=function(a,b,c){return vec3.normalize(vec3.subtract(a,b,c));}
var mat3={};mat3.create=function(a){var b=new glMatrixArrayType(9);if(a){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9]}return b};mat3.identity=function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return a};var mat4={};mat4.create=function(a){var b=new glMatrixArrayType(16);if(a){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15]}return b};mat4.identity=function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a};mat4.m=function(b,a,c){c||(c=b);var d=a[0],e=a[1],g=a[2],f=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],o=a[9],m=a[10],n=a[11],p=a[12],r=a[13],s=a[14];a=a[15];var A=b[0],B=b[1],t=b[2],u=b[3],v=b[4],w=b[5],x=b[6],y=b[7],z=b[8],C=b[9],D=b[10],E=b[11],q=b[12],F=b[13],G=b[14];b=b[15];c[0]=A*d+B*h+t*l+u*p;c[1]=A*e+B*i+t*o+u*r;c[2]=A*g+B*j+t*m+u*s;c[3]=A*f+B*k+t*n+u*a;c[4]=v*d+w*h+x*l+y*p;c[5]=v*e+w*i+x*o+y*r;c[6]=v*g+w*j+x*m+y*s;c[7]=v*f+w*k+x*n+y*a;c[8]=z*d+C*h+D*l+E*p;c[9]=z*e+C*i+D*o+E*r;c[10]=z*
g+C*j+D*m+E*s;c[11]=z*f+C*k+D*n+E*a;c[12]=q*d+F*h+G*l+b*p;c[13]=q*e+F*i+G*o+b*r;c[14]=q*g+F*j+G*m+b*s;c[15]=q*f+F*k+G*n+b*a;return c};mat4.mulPointZ=function(a,b){var d=b[0],e=b[1];b=b[2];return a[2]*d+a[6]*e+a[10]*b+a[14];};mat4.mulPoint=function(a,b,c){c||(c=b);var d=b[0],e=b[1];b=b[2];c[0]=a[0]*d+a[4]*e+a[8]*b+a[12];c[1]=a[1]*d+a[5]*e+a[9]*b+a[13];c[2]=a[2]*d+a[6]*e+a[10]*b+a[14];return c};mat4.mulVector=function(a,b,c){c||(c=b);var d=b[0],e=b[1];b=b[2];c[0]=a[0]*d+a[4]*e+a[8]*b;c[1]=a[1]*d+a[5]*e+a[9]*b;c[2]=a[2]*d+a[6]*e+a[10]*b;return c};mat4.rotate=function(a,b,c,d){var e=c[0],g=c[1];c=c[2];var f=Math.sqrt(e*e+g*g+c*c);if(!f)return null;if(f!=1){f=1/f;e*=f;g*=f;c*=f}var h=Math.sin(b),i=Math.cos(b),j=1-i;b=a[0];f=a[1];var k=a[2],l=a[3],o=a[4],m=a[5],n=a[6],p=a[7],r=a[8],s=a[9],A=a[10],B=a[11],t=e*e*j+i,u=g*e*j+c*h,v=c*e*j-g*h,w=e*g*j-c*h,x=g*g*j+i,y=c*g*j+e*h,z=e*c*j+g*h;e=g*c*j-e*h;g=c*c*j+i;if(d){if(a!=d){d[12]=a[12];d[13]=a[13];d[14]=a[14];d[15]=a[15]}}else d=a;d[0]=b*t+o*u+r*v;d[1]=f*t+m*u+s*v;d[2]=k*t+n*u+A*v;d[3]=l*t+p*u+B*
v;d[4]=b*w+o*x+r*y;d[5]=f*w+m*x+s*y;d[6]=k*w+n*x+A*y;d[7]=l*w+p*x+B*y;d[8]=b*z+o*e+r*g;d[9]=f*z+m*e+s*g;d[10]=k*z+n*e+A*g;d[11]=l*z+p*e+B*g;return d};mat4.frustum=function(a,b,c,d,e,g,f){f||(f=mat4.create());var h=b-a,i=d-c,j=g-e;f[0]=e*2/h;f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=e*2/i;f[6]=0;f[7]=0;f[8]=(b+a)/h;f[9]=(d+c)/i;f[10]=-(g+e)/j;f[11]=-1;f[12]=0;f[13]=0;f[14]=-(g*e*2)/j;f[15]=0;return f};mat4.perspective=function(a,b,c,d,e){a=c*Math.tan(a*Math.PI/360);b=a*b;return mat4.frustum(-b,b,-a,a,c,d,e)};mat4.ortho=function(a,b,c,d,e,g,f){f||(f=mat4.create());var h=b-a,i=d-c,j=g-e;f[0]=2/h;f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=2/i;f[6]=0;f[7]=0;f[8]=0;f[9]=0;f[10]=-2/j;f[11]=0;f[12]=-(a+b)/h;f[13]=-(d+c)/i;f[14]=-(g+e)/j;f[15]=1;return f};mat4.lookAt=function(a,b,c,d){d||(d=mat4.create());var e=a[0],g=a[1];a=a[2];var f=c[0],h=c[1],i=c[2];c=b[1];var j=b[2];if(e==b[0]&&g==c&&a==j)return mat4.identity(d);var k,l,o,m;c=e-b[0];j=g-b[1];b=a-b[2];m=1/Math.sqrt(c*c+j*j+b*b);c*=m;j*=m;b*=m;k=h*b-i*j;i=i*c-f*b;f=f*j-h*c;if(m=Math.sqrt(k*k+i*i+f*f)){m=1/m;k*=m;i*=m;f*=m}else f=i=k=0;h=j*f-b*i;l=b*k-c*f;o=c*i-j*k;if(m=Math.sqrt(h*h+l*l+o*o)){m=1/m;h*=m;l*=m;o*=m}else o=l=h=0;d[0]=k;d[1]=h;d[2]=c;d[3]=0;d[4]=i;d[5]=l;d[6]=j;d[7]=0;d[8]=f;d[9]=
o;d[10]=b;d[11]=0;d[12]=-(k*e+i*g+f*a);d[13]=-(h*e+l*g+o*a);d[14]=-(c*e+j*g+b*a);d[15]=1;return d};vec3.distance=function(a,b){var c=b[0]-a[0],e=b[1]-a[1],d=b[2]-a[2];return Math.sqrt(c*c+e*e+d*d);}
vec3.sub_ip=function(a,b){a[0]-=b[0];a[1]-=b[1];a[2]-=b[2];}
vec3.sub_r=function(a,b){var d=[a[0]-b[0],a[1]-b[1],a[2]-b[2]];return d;}
vec3.cpy=function(dst,src){dst[0]=src[0];dst[1]=src[1];dst[2]=src[2];}
vec3.add_ip=function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];}
vec3.add_r=function(a,b){var d=[a[0]+b[0],a[1]+b[1],a[2]+b[2]];return d;}
vec3.scale_ip=function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;}
vec3.scale_r=function(a,b){var d=[a[0]*b,a[1]*b,a[2]*b];return d;}
vec3.cross_r=function(a,b){var d=a[0],e=a[1];a=a[2];var g=b[0],f=b[1];b=b[2];var c=[e*b-a*f,a*g-d*b,d*f-e*g];return c;}
vec3.cross_rn=function(a,b){var c=vec3.cross_r(a,b);vec3.normalize(c);return c;}
vec3.lerp_r=function(a,b,c){var d=[a[0]+c*(b[0]-a[0]),a[1]+c*(b[1]-a[1]),a[2]+c*(b[2]-a[2])];return d};vec3.lerp_ip=function(a,b,c,d){d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);d[2]=a[2]+c*(b[2]-a[2]);};vec3.compare=function(a,b,e){return(Math.abs(a[0]-b[0])<e)&&(Math.abs(a[1]-b[1])<e)&&(Math.abs(a[2]-b[2])<e);};vec3.crossN=function(a,b,c){c||(c=a);var d=a[0],e=a[1];a=a[2];var g=b[0],f=b[1];b=b[2];var x=e*b-a*f,y=a*g-d*b,z=d*f-e*g;g=Math.sqrt(x*x+y*y+z*z);if(g){if(g==1){c[0]=x;c[1]=y;c[2]=z;}else{g=1/g;c[0]=x*g;c[1]=y*g;c[2]=z*g;}}else{c[0]=0;c[1]=0;c[2]=0;}return c;};mat4.setScale=function(tm,s){tm[10]=tm[5]=tm[0]=s;}
mat4.offset=function(tm,offset){tm[12]+=offset[0];tm[13]+=offset[1];tm[14]+=offset[2];}
mat4.copy=function(src,dst){for(var i=0;i<16;i++)dst[i]=src[i];}
mat4.m_z=function(b,a,c){var g=a[2],j=a[6],m=a[10],s=a[14];var A=b[0],B=b[1],t=b[2],u=b[3],v=b[4],w=b[5],x=b[6],y=b[7],z=b[8],C=b[9],D=b[10],E=b[11],q=b[12];c[2]=A*g+B*j+t*m+u*s;c[6]=v*g+w*j+x*m+y*s;c[10]=z*g+C*j+D*m+E*s;c[14]=q*g+b[13]*j+b[14]*m+b[15]*s;return c;};mat4.rotateAxisOrg=function(tm,org,axis,angle){var _org=[-org[0],-org[1],-org[2]];mat4.offset(tm,_org);var tmR=mat4.create();var tm2=mat4.create();mat4.identity(tmR);mat4.rotate(tmR,angle,axis);mat4.m(tm,tmR,tm2);mat4.copy(tm2,tm);mat4.offset(tm,org);}
mat4.setRow=function(tm,index,p){index*=4;tm[index]=p[0];tm[index+1]=p[1];tm[index+2]=p[2];};mat4.fromQuat=function(out,q){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,yx=y*x2,yy=y*y2,zx=z*x2,zy=z*y2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-yy-zz;out[1]=yx+wz;out[2]=zx-wy;out[3]=0;out[4]=yx-wz;out[5]=1-xx-zz;out[6]=zy+wx;out[7]=0;out[8]=zx+wy;out[9]=zy-wx;out[10]=1-xx-yy;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out;};var quat={};quat.slerp=function(out,a,b,t){var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=b[3];var omega,cosom,sinom,scale0,scale1;cosom=ax*bx+ay*by+az*bz+aw*bw;if(cosom<0.0){cosom=-cosom;bx=-bx;by=-by;bz=-bz;bw=-bw;}if((1.0-cosom)> 0.000001){omega=Math.acos(cosom);sinom=Math.sin(omega);scale0=Math.sin((1.0-t)*omega)/sinom;scale1=Math.sin(t*omega)/sinom;}else{scale0=1.0-t;scale1=t;}
out[0]=scale0*ax+scale1*bx;out[1]=scale0*ay+scale1*by;out[2]=scale0*az+scale1*bz;out[3]=scale0*aw+scale1*bw;return out;};quat.fromMat4=function(out,m){var fTrace=m[0]+m[5]+m[10],fRoot;if(fTrace > 0.0){fRoot=Math.sqrt(fTrace+1.0);out[3]=0.5*fRoot;fRoot=0.5/fRoot;out[0]=(m[6]-m[9])*fRoot;out[1]=(m[8]-m[2])*fRoot;out[2]=(m[1]-m[4])*fRoot;}else{var i=(m[5]> m[0])?1:0;if(m[10]> m[i*4+i])i=2;var j=(i+1)%3,k=(i+2)%3;fRoot=Math.sqrt(m[i*4+i]-m[j*4+j]-m[k*4+k]+1.0);out[i]=0.5*fRoot;fRoot=0.5/fRoot;out[3]=(m[j*4+k]-m[k*4+j])*fRoot;out[j]=(m[j*4+i]+m[i*4+j])*fRoot;out[k]=(m[k*4+i]+m[i*4+k])*fRoot;}return out;};iv.window=function(info){if(info.canvas){this.canvas=info.canvas;this.canvas.ivwindow=this;}else this.canvas=null;this.mvMatrix=mat4.create();this.mouseCaptured=false;this.mouseCancelPopup=false;this.mouseMoved=false;this.view=new iv.viewInfo({from:[0,0,6],to:[0,0,0],up:[0,1,0],fov:90});this.LY=this.LX=0;this.lastTouchDistance=-1;this.autoRotate=2;this.orbitMode=1;this.cameraMode=0;this.bkColor=(info.color!=undefined)?info.color:0x7f7f7f;this.initHardware();this.vpVersion=0;this.mvtmVersion=-1;this.cfgMinDistance=1e-6;this.cfgMaxDistance=1e8;this.timer=false;if(this.gl){if(info.file)this.load(info.file,info);else this.space=null;this.gl.enable(this.gl.DEPTH_TEST);this.initHandlers();this.initEvents();this.invalidate();}if(window.performance && window.performance.now)this.getTickCount=function(){return window.performance.now();};else this.getTickCount=function(){var d=new Date();var time=d.getTime();return time;};}
iv.window.prototype.setViewSize=function(w,h){var c=this.canvas,g=this.gl;if(w&&h&&c){c.height=h;c.width=w;if((g.viewportHeight!=h)||(g.viewportWidth!=w)){g.viewportHeight=h;g.viewportWidth=w;this.invalidate(iv.INV_VERSION);}}}
iv.window.prototype.initHandlers=function(){var w=this;var i={"move":function(event){return w._onMouseMove(event);},"down":function(event){return w.onMouseDown(event,false);},"up":function(event){return w.onMouseUp(event,false);},"dbl":function(event){return w._onDblClick(event);},"touchstart":function(event){return w.onMouseDown(event,true);},"touchcancel":function(event){return w.onTouchCancel(event);},"touchend":function(event){return w.onMouseUp(event);},"touchmove":function(event){return w.onTouchMove(event);},"menu":function(event){return w._onContextMenu(event);},"wheel":function(event){w.onMouseWheel(event);},"a":function(){w.animate();}};this.input=i;}
iv.window.prototype.initEvents=function(){var w=(/Firefox/i.test(navigator.userAgent))?"DOMMouseScroll":"mousewheel",c=this.canvas,i=this.input;this.setEvent(c,w,i.wheel);this.setEvent(c,"mousedown",i.down);this.setEvent(c,"mousemove",i.move);this.setEvent(c,"dblclick",i.dbl);this.setEvent(c,"contextmenu",i.menu);this.setEvent(c,"touchstart",i.touchstart);this.setEvent(c,"selectstart",function(){return false;});}
iv.window.prototype.releaseCapture=function(){if(this.mouseCaptured){var e=this.canvas,i=this.input;if(e.releaseCapture)e.releaseCapture();else
{e=document;this.delEvent(e,"mousemove",i.move);this.delEvent(e,"contextmenu",i.menu);}this.delEvent(e,"mouseup",i.up);this.delEvent(e,"touchmove",i.touchmove);this.delEvent(e,"touchend",i.touchend);this.delEvent(e,"touchcancel",i.touchcancel);this.mouseCaptured=false;}}
iv.window.prototype.setCapture=function(){if(!this.mouseCaptured){var e=this.canvas,i=this.input;if(e.setCapture)e.setCapture();else
{e=document;this.setEvent(e,"mousemove",i.move);this.setEvent(e,"contextmenu",i.menu);}this.setEvent(e,"mouseup",i.up);this.setEvent(e,"touchmove",i.touchmove);this.setEvent(e,"touchend",i.touchend);this.setEvent(e,"touchcancel",i.touchcancel);this.mouseCaptured=true;}}
iv.window.prototype.notify=function(a,b,def){var _i=this.refTargets;if(_i){b=b||{};b.code=a;b.wnd=this;if(def)b.doDef=true;for(var i=0;i<_i.length;i++)_i[i](b);return !def||b.doDef;}return true;}
iv.window.prototype.removeRefTarget=function(f){if(this.refTargets){var i=iv.indexOf(this.refTargets,f);if(i>=0){if(this.refTargets.length==1)this.refTargets=null;else this.refTargets.splice(i,1);return true;}}return false;}
iv.window.prototype.addRefTarget=function(f){if(!f)return false;if(this.refTargets){if(iv.indexOf(this.refTargets,f)>=0)return false;this.refTargets.push(f);}else this.refTargets=[f];return true;}
iv.window.prototype.delEvent=function(d,e,f){if(d.detachEvent)d.detachEvent("on"+e,f);else if(d.removeEventListener)d.removeEventListener(e,f);}
iv.window.prototype.setEvent=function(d,e,f){if(d.attachEvent)d.attachEvent("on"+e,f);else if(d.addEventListener)d.addEventListener(e,f);}
iv.window.prototype.getWindow=function(){return this;}
iv.window.prototype.initHardware=function(){var r=null;if(window.requestAnimationFrame)r=window.requestAnimationFrame;else
if(window.webkitRequestAnimationFrame)r=window.webkitRequestAnimationFrame;else
if(window.mozRequestAnimationFrame)r=window.mozRequestAnimationFrame;else
r=function(callback){window.setTimeout(callback,1000/60)};this.requestAnimFrame=r;var n=["webgl","experimental-webgl","webkit-3d","moz-webgl"];for(var i=0;i<n.length;i++){try{this.gl=this.canvas.getContext(n[i],{alpha:false});}catch(e){}if(this.gl){this.gl.viewportWidth=this.canvas.width;this.gl.viewportHeight=this.canvas.height;break;}}if(!this.gl){alert("Could not initialise WebGL");}return this.gl!=null;}
iv.viewInfo=function(v){this.from=[];this.to=[];this.up=[];this.scale=1;this.update(v);}
iv.viewInfo.prototype.update=function(from,to,up){if(from){if(to){vec3.cpy(this.from,from);vec3.cpy(this.to,to);vec3.cpy(this.up,up);}else{var V=from;vec3.cpy(this.from,V.from);vec3.cpy(this.to,V.to);vec3.cpy(this.up,V.up);if(V.ortho){this.scale=V.scale;}
else
if(V.fov)this.fov=V.fov;this.camera=from.camera?from.camera:null;}}}
iv.viewInfo.prototype.getUpVector=function(v){return vec3.subtract(this.up,this.from,v||[]);}
iv.viewInfo.prototype.getViewVector=function(v){return vec3.subtract(this.to,this.from,v||[]);}
iv.viewInfo.prototype.getViewVectorN=function(v){return vec3.subtractN(this.to,this.from,v||[]);}
iv.viewInfo.prototype.compare=function(v){return(vec3.compare(this.from,v.from,1e-6)&&vec3.compare(this.to,v.to,1e-6)&&vec3.compare(this.up,v.up,1e-6));}
iv.window.prototype.getView=function(i){if(i)i.update(this.view);else i=new iv.viewInfo(this.view);return i;}
iv.transitionView=function(wnd,view,flags){this.transition=iv.easeInOut;this.type="view";this.wnd=wnd;this.old=wnd.getView();this.target=view;this.current=new iv.viewInfo(null);if(flags)this.flags=flags;this.duration=600;this.tm=[];this.prepare(view);this.prepare(this.old);this._dir=[0,0,-1];this._up=[0,1,0];}
iv.transitionView.prototype.calcQ=function(a1,a0,b1,b0,up){var _a=vec3.sub_r(a1,a0),_b=vec3.sub_r(b1,b0),la=vec3.length(_a),lb=vec3.length(_b);var a=vec3.scale(_a,1/la,[]);var b=vec3.scale(_b,1/lb,[]);var r={l0:la,l1:lb,a:a,b:b};var ac=vec3.dot(a,b),d=0.9999;if((ac<-d)&& up){r.axis=up.slice();r.angle=Math.PI;}else{if((ac<d)&&(ac>-d)){r.angle=Math.acos(ac);r.axis=vec3.cross(a,b,[]);}else
{vec3.cpy(r.a,_a);vec3.cpy(r.b,_b);}}return r;}
iv.transitionView.prototype.detach=function(wnd,f){if(f && this.flags && this.target.anim){f=wnd._playFavAnimation(this.target,(this.flags&(iv.VIEW_ANIM_SET|iv.VIEW_ANIM_PLAY)));if(f&iv.VIEW_INVALIDATE)wnd.invalidate();}
else
{if(this.wnd.autoRotate&2)this.wnd.startAR();}}
iv.transitionView.prototype.prepare=function(v){v._dir=vec3.subtract(v.to,v.from,[]);v._dirLen=vec3.length(v._dir);v._up=vec3.subtract(v.up,v.from,[]);v._upLen=vec3.length(v._up);if(v._dirLen)vec3.scale(v._dir,1/v._dirLen);if(v._upLen)vec3.scale(v._up,1/v._upLen);var _from=[0,0,0];var tm=mat4.lookAt(_from,v._dir,v._up,[]);mat4.invert(tm,tm);v._Q=quat.fromMat4([],tm);}
iv.transitionView.prototype.animate=function(k){var c=this.current,t=this.target,o=this.old,_k=1-k;if(k>0.999){k=1;_k=0;vec3.cpy(c.from,t.from);vec3.cpy(c.to,t.to);vec3.cpy(c.up,t.up);}else{vec3.lerp_ip(o.to,t.to,k,c.to);var q=[],upL=t._upLen*k+o._upLen*_k,dirL=t._dirLen*k+o._dirLen*_k;quat.slerp(q,o._Q,t._Q,k);mat4.fromQuat(this.tm,q);mat4.mulVector(this.tm,this._dir,c.from);mat4.mulVector(this.tm,this._up,c.up);vec3.scale(c.from,-dirL);vec3.scale(c.up,upL);vec3.add(c.from,c.to);vec3.add(c.up,c.from);}this.wnd.setView(c);return 7;}
iv.window.prototype.setOrtho=function(b){var v=this.view;if(v.ortho==b)return false;var l=vec3.distance(v.from,v.to);if(b){v.scale=1.0/(l*Math.tan(Math.PI*v.fov/(360)));}else
{l*=v.scale;if(l>1e-6){v.fov=Math.atan(1/l)*360/Math.PI;}}
v.ortho=b;this.invalidate(iv.INV_VERSION);return true;};iv.window.prototype._cmpViews=function(V,v){if(v.from && v.to && v.up){if(V.compare(v)){if(v.fov){if(V.fov==v.fov && !V.ortho)return false;}else
if(v.scale){if(V.scale==v.scale && this.ortho)return false;}
else return false;}}return true;}
iv.window.prototype.setView=function(V,flags){if(!V)return;var v=new iv.viewInfo(V);var _dir=[],_up=v.getUpVector();vec3.subtractN(v.to,v.from,_dir);var _dot=vec3.dot(_dir,_up);if(Math.abs(_dot)>1e-5){var a2=[],a1=[];vec3.crossN(_dir,_up,a2);vec3.crossN(_dir,a2,a1);_dot=vec3.dot(_up,a1);if(_dot<0)vec3.scale(a1,-1);vec3.add(v.from,a1,v.up);}if(flags===undefined)flags=0;V=this.view;if(this._cmpViews(V,v)){if(flags&iv.VIEW_TRANSITION){this.stopAR();this.removeAnimationType("view",true);this.addAnimation(new iv.transitionView(this,v,flags));return;}
V.update(v);}if(flags&iv.VIEW_INVALIDATE)this.invalidate(iv.INV_VERSION);}
iv.window.prototype.setDefView=function(flags){this.stopAR();if(flags===undefined)flags=iv.VIEW_INVALIDATE;this.setView(this.space.view,flags);}
iv.window.prototype.load=function(file,d){var s=new iv.space(this,this.gl),w=this;if(d && d.path)s.path=d.path;var r=iv.createRequest(file,s.path),ext;if(d && d.type)ext=d.type;else ext=file.substr(file.lastIndexOf('.')+1);ext=ext.toUpperCase();if(ext=='IV3D'){r.responseType="arraybuffer";r.onprogress=function(e){if(e.lengthComputable)w.notify("progress",{loaded:e.loaded,total:e.total});}};r.onreadystatechange=function(){if(this.readyState==4 && this.status==200){w.space=s;if(ext=='IV3D')s.loadBin(this.response);else s.load(JSON.parse(this.responseText));w.setDefView();w.notify("dataReady");w.startAR();}}
r.send();}
iv.window.prototype.getDoubleSided=function(){return this.space?this.space.cfgDbl:false;}
iv.window.prototype.setDoubleSided=function(b){if(this.space.cfgDbl!=b){var s=this.space;s.cfgDbl=b;s.invalidate();}}
iv.window.prototype.getMaterials=function(){return this.space?(this.space.cfgDefMtl==null):false;}
iv.window.prototype.setMaterials=function(b){var s=this.space;if(b){if(s.cfgDefMtl){s.cfgDefMtl.clear();s.cfgDefMtl=null;this.invalidate();}}else{if(!s.cfgDefMtl){var m=new iv.material(s);m.load({"diffuse":0xcccccc,"specular":0x808080,"ambient":0x050505,"phong":25.6});s.cfgDefMtl=m;this.invalidate();};}};iv.window.prototype.getTextures=function(){return this.space?this.space.cfgTextures:false;}
iv.window.prototype.setTextures=function(b){if(this.space && this.space.cfgTextures!=b){this.space.cfgTextures=b;this.invalidate();}}
iv.window.prototype.setLights=function(l){var s=this.space;if(!s)return false;if(l){s.lights=l;s.stdLights=true;}else
{s.lights=[];s.stdLights=false;}this.invalidate(iv.INV_MTLS);}
iv.window.prototype.onMouseUp=function(event,touch){var a=this.last;var ar=this.autoRotate;if(a){this.last=null;}if(ar&2)this.startAR();this.releaseCapture();};iv.window.prototype.getTouchDistance=function(e){var dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;return Math.sqrt(dx*dx+dy*dy);}
iv.window.prototype.getClientPoint=function(e,touch){var r=this.canvas.getBoundingClientRect();var x,y;if(e){if(touch && e.touches && e.touches.length)e=e.touches[0];x=e.clientX-r.left;y=e.clientY-r.top;}else{x=this.LX;y=this.LY;}return{"x":x,"y":y,"r":r}}
iv.window.prototype.decodeButtons=function(e,bt){var btn=0;if(bt && e.touches!=undefined){if(e.touches.length>=3)return 4;return 1;}if(e.buttons==undefined){if(e.which==1)btn=1;else
if(e.which==2)btn=4;else
if(e.which==3)btn=2;else btn=1;}else btn=e.buttons;return btn;}
iv.window.prototype.pd=function(e){if(e && e.preventDefault)e.preventDefault();}
iv.window.prototype._onContextMenu=function(event){this.pd(event);if(this.mouseCancelPopup){this.mouseCancelPopup=false;return false;}if(this.onContextMenu)this.onContextMenu(event);return true;}
iv.window.prototype._onDblClick=function(event){if(this.onDblClick)this.onDblClick(event,false);this.pd(event);event.stopPropagation();return true;}
iv.window.prototype.onTouchMove=function(event){this.onMouseMove(event,true);this.pd(event);return false;}
iv.window.prototype.onTouchCancel=function(event){this.onMouseUp(event,true);if(event.cancelable)this.pd(event);}
iv.window.prototype._onMouseMove=function(event){if(this.mouseCaptured){var b=this.decodeButtons(event,false);if(b)this.onMouseMove(event,false);else this.onMouseUp(event,false);this.pd(event);event.stopPropagation();return true;}
else{var p=this.getClientPoint(event,false);p.b=0;if(this.handler && this.handler.onMouseHover){if(!this.onHandler(this.handler.onMouseHover(p,event)))return false;}if(this.onMouseHover)this.onMouseHover(event,p);}return false;}
iv.window.prototype.onMouseHover=function(event,p){this.notify("mousehover",p);}
iv.window.prototype.onMouseDown=function(event,touch){this.last={x:0,y:0,t:0};var e=event;this.lastTouchDistance=-1;if(touch){e=event.touches[0];if(event.touches.length==2)this.lastTouchDistance=this.getTouchDistance(event);}
var p=this.getClientPoint(e,touch);p.b=this.decodeButtons(event,touch);this.pd(event);this.setCapture();this.stopAR();this.LX=p.x;this.LY=p.y;this.mouseMoved=false;}
iv.window.prototype.onMouseMove=function(event,touch){var e=event,p=this.getClientPoint(e,touch);if(touch){e=event.touches[0];if(event.touches.length==2){var d=this.getTouchDistance(event);if(this.lastTouchDistance!=d){if(this.lastTouchDistance>0){var _d=this.lastTouchDistance-d;this.doDolly(_d,_d);this.invalidate(iv.INV_VERSION);}this.lastTouchDistance=d;this.mouseMoved=true;this.LX=p.x;this.LY=p.y;}else this.lastTouchDistance-1;return;}}
var dX=p.x-this.LX,dY=p.y-this.LY;if(this.mouseMoved||Math.abs(dX)||Math.abs(dY)){this.removeAnimationType("view",true);var b=p.b=this.decodeButtons(event,touch),flags=3;if(this.cameraMode && b==1){if(this.cameraMode==1)b=2;else
if(this.cameraMode==2)b=4;else
if(this.cameraMode==3)b=8;}if(b&8){if(this.doLook){this.doLook(dX,dY);flags|=8;}}else
if(b&4){this.doPan(dX,dY);flags|=8;}else
if(b&1){var a=this.last;if(a){a.x=dX+a.x/2;a.y=dY+a.y/2;var t=this.getTickCount();a.dt=t-a.t;a.t=t;}this.doOrbit(dX,dY);flags|=8;}
else
if(b&2){if(!this.doDolly(dX,dY))return;flags|=8;this.mouseCancelPopup=true;}this.onHandler(flags);this.LX=p.x;this.LY=p.y;this.mouseMoved=true;}}
iv.window.prototype.onHandler=function(flags){var invF=0;if(flags&8){flags|=2;invF=iv.INV_VERSION;}if(flags&2)this.invalidate(invF);return(flags&1)?true:false;}
iv.window.prototype.onMouseWheel=function(event){var d;if(event.wheelDelta!=undefined)d=event.wheelDelta/-10;else
if(event.detail!=undefined){d=event.detail;if(d>10)d=10;else if(d<-10)d=-10;d*=4;}this.doDolly(0,d);this.invalidate(iv.INV_VERSION);this.pd(event);}
iv.window.prototype.doPan=function(dX,dY){var i={type:"pan",dX:dX,dY:dY};if(this.notify("camera",i,true)){var v=this.getView();var gl=this.gl;var x0=gl.viewportWidth/2,y0=gl.viewportHeight/2;var r0=this.getRay(x0,y0),r1=this.getRay(x0-i.dX,y0-i.dY);var d=[r1[3]-r0[3],r1[4]-r0[4],r1[5]-r0[5]];vec3.add_ip(v.from,d);vec3.add_ip(v.up,d);vec3.add_ip(v.to,d);this.setView(v);}}
iv.window.prototype.doOrbit=function(dX,dY){var i={type:"orbit",dX:dX,dY:dY};if(this.notify("camera",i)){dX=i.dX;dY=i.dY;var v=this.getView(),tm=[];var _u=v.getUpVector();if(dX && this.orbitMode){mat4.identity(tm);mat4.rotateAxisOrg(tm,v.to,_u,-dX/200.0);mat4.mulPoint(tm,v.from);mat4.mulPoint(tm,v.up);dX=0;}if(dY){vec3.normalize(_u);var _d=v.getViewVectorN();var _axis=vec3.cross(_d,_u,[]);mat4.identity(tm);var angle=dY/200.0;if(this.cfgMaxVAngle!=undefined){var viewAngle=Math.acos(Math.max(Math.min(vec3.dot(_d,[0,0,-1]),1),-1));var max=(90-this.cfgMinVAngle)*Math.PI/180,min=(90-this.cfgMaxVAngle)*Math.PI/180;if((viewAngle-angle)>max)angle=viewAngle-max;else
if((viewAngle-angle)<min)angle=viewAngle-min;}
mat4.rotateAxisOrg(tm,v.to,_axis,-angle);mat4.mulPoint(tm,v.from);mat4.mulPoint(tm,v.up);}if(dX){_u=[0,0,1];mat4.identity(tm);mat4.rotateAxisOrg(tm,v.to,_u,-dX/200.0);mat4.mulPoint(tm,v.from);mat4.mulPoint(tm,v.up);}this.setView(v);}}
iv.window.prototype.doDolly=function(dX,dY){var i={type:"dolly",dX:dX,dY:dY},v=this.getView();if(this.viewOrtho){var k=1.0+(dY/100);if(k<1e-1000)k=1e-1000;i.scale=this.viewScale/k;if(!this.notify("camera",i,true))return false;this.viewScale=i.scale;}else{var dir=vec3.sub_r(v.from,v.to);var l=vec3.length(dir);i.len=Math.min(Math.max(l+l*dY/100,this.cfgMinDistance),this.cfgMaxDistance);if(!this.notify("camera",i,true))return false;vec3.scale_ip(dir,i.len/l);var delta=vec3.sub_r(vec3.add_r(v.to,dir),v.from);vec3.add_ip(v.from,delta);vec3.add_ip(v.up,delta);this.setView(v);}return true;}
iv.window.prototype.doFOV=function(dX,dY){var V=this.view;var i={type:"fov",dX:dX,dY:dY,fov:Math.min(Math.max(V.fov+dY/8,1),175)};if((i.fov!=V.fov)&&this.notify("camera",i,true)){V.fov=i.fov;return true;}return false;}
iv.window.prototype.getRay=function(x,y,r){var gl=this.gl,w=gl.viewportWidth,h=gl.viewportHeight;var v=this.view;var p1=v.from,p2=v.to;var dir=vec3.sub_r(v.to,v.from);var up=v.getUpVector();vec3.normalize(up);var vx=vec3.cross_rn(dir,up),h2=h/2,w2=w/2,i;if(!r)r=[];if(this.viewOrtho){var dy=(h2-y)/h2,dx=(x-w2)/h2;var k=1/v.scale;vec3.scale(vx,dx*k);vec3.scale(up,dy*k);for(i=0;i<3;i++)r[i]=p1[i]+up[i]+vx[i];}else{var k=vec3.length(dir)*Math.tan(Math.PI*v.fov/360);var ky=(h2-y)/h2,kx=(x-w2)/w2;vec3.scale(up,k*ky);vec3.scale(vx,k*kx*w/h);vec3.cpy(r,p1);}
for(i=0;i<3;i++)r[i+3]=p2[i]+up[i]+vx[i];return r;}
iv.window.prototype.updateMVTM=function(){if(this.vpVersion!=this.mvtmVersion){this.mvtmVersion=this.vpVersion;var v=this.view;mat4.lookAt(v.from,v.to,v.getUpVector(),this.mvMatrix);if(v.camera &&(v.camera.object instanceof iv.camera)){var c=v.camera,C=c.object;if(!c.camTM){c.camTM=[];c.camTMi=[];mat4.lookAt(C.from,C.to,vec3.subtractN(C.up,C.from,[]),c.camTM);mat4.invert(c.camTMi,c.camTM);}
var tm=c.enableTM();var tmi=[];mat4.invert(tmi,this.mvMatrix);mat4.m(c.camTM,tmi,tm);var tm2=[];mat4.m(c.camTM,tm,tm2);}}}
iv.window.prototype.drawScene=function(){var gl=this.gl;gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight);var s=this.space;if(!s||!s.bk||(!s.drawBk())){var bk=this.bkColor;gl.clearColor(((bk>>16)&0xff)/255.0,((bk>>8)&0xff)/255.0,(bk&0xff)/255.0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);}if(s){this.updateMVTM();s.render(this.mvMatrix);}this.timer=false;}
iv.window.prototype.invalidate=function(f){if(f!==undefined){if(f&iv.INV_VERSION)this.vpVersion++;if(f&iv.INV_MTLS && this.space)this.space.invalidateMaterials();}if(this.timer)return;this.timer=true;this.requestAnimFrame.call(window,this.drawScene.bind(this));}
iv.easeInOut=function(a){return 0.5+Math.sin((a-0.5)*Math.PI)/2;}
iv.window.prototype.animate=function(){var j=0,rez=0,uFlags=0,inv=false,bKill=true;var time=this.getTickCount();var _i=this.transitions;while(j<_i.length){var i=_i[j];var bDel=false;if(i.lastTime!=time){if(i.duration){var a=(time-i.startTime)/i.duration;if((a>=1.0)||(a<0)){a=1.0;bDel=true;}if(i.transition)a=i.transition(a);rez=i.animate(a);}else
{rez=i.animate(Math.max(time-i.lastTime,0));if(!(rez&1))bDel=true;}
i.lastTime=time;}if(rez&2)inv=true;if(rez&4)uFlags|=iv.INV_VERSION;if(bDel){_i.splice(j,1);if(i.detach)i.detach(this,true);}else j++;}if(inv)this.invalidate(uFlags);if(!_i.length){clearInterval(this.transTimer);this.transTimer=null;}}
iv.window.prototype.getAnimation=function(type){var _i=this.transitions;if(_i){for(var i=0;i<_i.length;i++){var t=_i[i];if(t.type && t.type==type)return i;}}return-1;};iv.window.prototype.removeAnimationType=function(type,e){var _i=this.transitions,i,t;if(_i){for(i=0;i<_i.length;i++){t=_i[i];if(t.type && t.type==type){if(e && t.duration)t.animate(1.0);if(t.detach)t.detach(this,false);_i.splice(i,1);return true;}}}return false;};iv.window.prototype.removeAnimation=function(a){var _i=this.transitions;if(_i){var i=iv.indexOf(_i,a);if(i>-1){if(a.detach)a.detach(this,false);_i.splice(i,1);return true;}}return false;}
iv.window.prototype.addAnimation=function(i){i.lastTime=this.getTickCount();if(i.duration)i.startTime=i.lastTime;if(!this.transitions)this.transitions=[];this.transitions.push(i);if(!this.transTimer){var w=this;this.transTimer=setInterval(this.input.a,10);}return true;};iv.anim.spin2=function(wnd,t){this.wnd=wnd;this.type="spin2";this.time=this.startTime=wnd.getTickCount();this.speed=0;this.x=1.0;this.y=0.1;this.startDelay=5000;}
iv.anim.spin2.prototype.animate=function(a){if(this.time<this.startTime)this.time=this.startTime;else
this.time+=a;if((this.time-this.startTime)>this.startDelay){if(this.speed<1){this.speed=this.speed*1.01+0.01;if(this.speed>1)this.speed=1.0;}this.wnd.doOrbit(this.x*this.speed,this.y*this.speed*this.wnd.orbitmode);return 7;}else return 1;}
iv.window.prototype.startAR=function(){var a=this.getAnimation("spin2");if(a>=0)this.transitions[a].startTime=this.getTickCount();else this.addAnimation(new iv.anim.spin2(this));}
iv.window.prototype.stopAR=function(){this.removeAnimationType("spin2");}
iv.space=function(view,gl){this.gl=gl;this.window=view;this.root=null;this.view=null;this.materials=[];this.cfgTextures=true;this.cfgDbl=true;this.cfgKeepMeshData=3;this.cfgDefMtl=null;this.cfgSelZOffset=false;this.cfgRMode=0;this.clrSelection=[1,0,0];this.stdLights=false;this.rmodes=[
{f:{n:true}},{f:null,e:{n:true}}
];this.lights=[];this.activeShader=null;this.q=[];for(var i=1;i<8;i++)this.q[i]=({L:0,I:[]});this.tmTmp=mat4.create();this.projectionTM=mat4.create();this.modelviewTM=mat4.create();this.textures=[];this.meshesInQueue=0;if(gl){this.e_ans=(gl.getExtension('EXT_texture_filter_anisotropic')||gl.getExtension('MOZ_EXT_texture_filter_anisotropic')||gl.getExtension('WEBKIT_EXT_texture_filter_anisotropic'));if(this.e_ans)this.e_ansMax=gl.getParameter(this.e_ans.MAX_TEXTURE_MAX_ANISOTROPY_EXT);}}
iv.space.prototype.getWindow=function(){return this.window;}
iv.space.prototype.onMeshLoaded=function(m){this.meshesInQueue--;if(!this.meshesInQueue){var w=this.window;if(w && w.onMeshesReady)w.onMeshesReady(w,this);}this.invalidate();};iv.space.prototype.updateShadeArgs=function(a){var gl=this.gl,i;var p=this.activeShader;var ca=(p)?p.attrs.length:0,na=a?a.attrs.length:0;if(na>ca){for(i=ca;i<na;i++)gl.enableVertexAttribArray(i);}
else if(na<ca){for(i=na;i<ca;i++)gl.disableVertexAttribArray(i);}
ca=p?p.textures.length:0;for(i=0;i<ca;i++){gl.activeTexture(gl.TEXTURE0+i);var txt=p.textures[i];var type=txt.txt.ivtype;gl.bindTexture(type===undefined?gl.TEXTURE_2D:type,null);}}
iv.space.prototype.c1=function(s,info,flags){if(s!=this.activeShader)this.updateShadeArgs(s);if(s)s.activate(this,info,flags,s==this.activeShader);else this.gl.useProgram(null);this.activeShader=s;}
iv.space.prototype.c2=function(m,info,flags){var s=m?m.getShader(flags):0;if(s && !s.bValid){if(this.activeShader)this.c1(null,null);s.update(m);}this.c1(s,info,flags);return s;}
iv.bk3d=function(space,txt){var gl=space.gl;this.uv=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.uvBuffer=iv.bufferF(gl,this.uv,2);this.vBuffer=iv.bufferF(gl,[-1.0,-1.0,0.0,1.0,-1.0,0.0,-1.0,1.0,0.0,-1.0,1.0,0.0,1.0,-1.0,0.0,1.0,1.0,0.0],3);var mtl=new iv.material(space);mtl.load({emissive:{texture:txt,wrapS:gl.CLAMP_TO_EDGE,wrapT:gl.CLAMP_TO_EDGE}});this.mtl=mtl;this.texture=mtl.emissive[0].texture;}
iv.space.prototype.drawBk=function(){if(this.bk&&this.bk.texture.ivready){var gl=this.gl;if(gl.viewportHeight&&gl.viewportWidth){gl.clear(gl.DEPTH_BUFFER_BIT);var bk=this.bk;var b=null;var w=512,h=512;var img=bk.texture.image;if(img && img.naturalWidth)w=img.naturalWidth;else if(bk.texture.width)w=bk.texture.width;if(img && img.naturalHeight)h=img.naturalHeight;else if(bk.texture.height)h=bk.texture.height;var s=this.c2(bk.mtl,{opacity:1.0},2);for(var i=0;i<s.attrs.length;i++){var v=s.attrs[i];switch(v.id){case 4300: b=bk.vBuffer;gl.bindBuffer(gl.ARRAY_BUFFER,b);break;case 4302:{b=bk.uvBuffer;gl.bindBuffer(gl.ARRAY_BUFFER,b);var kx=gl.viewportWidth/w,ky=gl.viewportHeight/h;var x=0,y=0;if(kx>ky)y=(1.0-ky/kx)/2;else
if(kx<ky)x=(1.0-kx/ky)/2;var uv=bk.uv;if(Math.abs(uv[0]-x)>1e-5||Math.abs(uv[1]-y)>1e-5){uv[0]=x;uv[1]=y;uv[2]=1.0-x;uv[3]=y;uv[4]=x;uv[5]=1.0-y;uv[6]=x;uv[7]=1.0-y;uv[8]=1.0-x;uv[9]=y;uv[10]=1.0-x;uv[11]=1.0-y;gl.bufferData(gl.ARRAY_BUFFER,uv,gl.STATIC_DRAW);}}break;}if(b)gl.vertexAttribPointer(v.slot,b.itemSize,gl.FLOAT,false,0,0);}
gl.disable(gl.DEPTH_TEST);gl.depthMask(false);gl.drawArrays(gl.TRIANGLES,0,6);gl.enable(gl.DEPTH_TEST);gl.depthMask(true);return true;}}return false;}
iv.space.prototype.invalidate=function(f){this.window.invalidate(f);}
iv.handleLoadedTexture=function(texture){function isPOW2(v){return(v&(v-1))==0;}if(texture.image.naturalWidth>0 && texture.image.naturalHeight>0){var type=texture.ivtype;var gl=texture.ivspace.gl;gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true);gl.bindTexture(type,texture);gl.texImage2D(type,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,texture.image);var pot=isPOW2(texture.image.naturalWidth)&&isPOW2(texture.image.naturalHeight);gl.texParameteri(type,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(type,gl.TEXTURE_MIN_FILTER,pot?gl.LINEAR_MIPMAP_NEAREST:gl.LINEAR);if(pot)gl.generateMipmap(type);gl.bindTexture(type,null);texture.ivready=true;texture.ivpot=pot;texture.ivspace.invalidate();}delete texture.image.ivtexture;delete texture.ivspace;}
iv.handleLoadedCubeTexture=function(image){var texture=image.ivtexture;var gl=texture.ivspace.gl;gl.bindTexture(gl.TEXTURE_CUBE_MAP,texture);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,false);gl.texImage2D(image.ivface,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,image);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.bindTexture(gl.TEXTURE_CUBE_MAP,null);texture.ivnumfaces++;if(texture.ivnumfaces==6){texture.ivready=true;texture.ivspace.invalidate();delete texture.ivspace;}delete image.ivtexture;};iv.space.prototype.getTexture=function(str,type,mtl){var t;for(var i=0;i<this.textures.length;i++){var t=this.textures[i];if((t.ivfile==str)&&(t.ivtype==type)){t.ivrefcount++;return t;}}
var gl=this.gl;t=this.gl.createTexture();t.ivspace=this;t.ivready=false;t.ivfile=str;t.ivtype=type;t.ivrefcount=1;var path=(mtl && mtl.path)?mtl.path:this.path;if(type==gl.TEXTURE_CUBE_MAP){var faces=[["posx",gl.TEXTURE_CUBE_MAP_POSITIVE_X],["negx",gl.TEXTURE_CUBE_MAP_NEGATIVE_X],["posy",gl.TEXTURE_CUBE_MAP_POSITIVE_Y],["negy",gl.TEXTURE_CUBE_MAP_NEGATIVE_Y],["posz",gl.TEXTURE_CUBE_MAP_POSITIVE_Z],["negz",gl.TEXTURE_CUBE_MAP_NEGATIVE_Z]];t.ivnumfaces=0;var _str=str.split(".");if(path)_str[0]=path+_str[0];for(var i=0;i<6;i++){var filename=_str[0]+faces[i][0]+"."+_str[1];var image=new Image();image.ivtexture=t;image.ivface=faces[i][1];image.onload=function(){iv.handleLoadedCubeTexture(this)};image.src=filename;}}else
if(str=='*camera'){if(iv.HandleCameraTexture)iv.HandleCameraTexture(t);}
else
{t.image=new Image();t.image.ivtexture=t;t.filter=iv.FILTER_MIPMAP;t.image.onload=function(){iv.handleLoadedTexture(this.ivtexture)};t.image.src=path?path+str:str;}this.textures.push(t);return t;}
iv.space.prototype.newMaterial=function(n){var mtl=new iv.material(this);this.materials.push(mtl);var t=typeof n;if(t=='string')mtl.name=name;else
if(t=='object')mtl.load(n);return mtl;}
iv.space.prototype.getBinData=function(b,i){return new DataView(b,i.pos,i.szCmp);}
iv.space.prototype.loadBin=function(buffer){var data=new DataView(buffer);var ms=[];var l=data.byteLength,i=0;var root=null;while(i<l){var id=data.getUint32(i,true);var d={pos:i+12,id:id,sz:data.getUint32(i+4,true),szCmp:data.getUint32(i+8,true)};if((id&0xff000000)==0x01000000)ms[id&0xffffff]=d;else
if(id==0x746f6f72)root=d;i+=d.szCmp+12;}if(root){var data=this.getBinData(buffer,root);var text=ZIP.inflateStr(data,root.sz);var js=JSON.parse(text);if(js && js.space){var d={objects:[]};l=ms.length;for(i=0;i<l;i++)d.objects.push(new iv.mesh(this.gl));this.loadImp(js,d);for(i=0;i<l;i++){var info=ms[i];d.objects[i].load(this,ZIP.inflateBin(this.getBinData(buffer,info),info.sz));}}}}
iv.space.prototype.loadImp=function(data,d){var s=data.space,i,a;d.materials=[];d.space=this;if(s.materials)for(i=0;i<s.materials.length;i++){var mtl=this.newMaterial(s.materials[i]);d.materials.push(mtl);}if(s.root){if(!this.root)this.root=new iv.node();this.root.load(s.root,d);}if(s.anims){this.anims=s.anims;for(i=0;i<s.anims.length;i++){a=s.anims[i];if(a.active){this.activateAnimation(a);break;}}}if(s.view){a=s.view;this.view={from:a.from||a.org,to:a.to||a.target,up:a.up};if(a.fov)this.view.fov=a.fov;if(a.viewScale)this.view.scale=a.viewScale;if(a.camera)this.view.camera=this.root.searchId(a.camera)}if(s.config){var c=s.config;for(var v in c){switch(v){case "bkfaces":this.cfgDbl=c[v];break;}}}if(s.views)this.views=s.views;if(data.space.bk!=undefined)this.bk=new iv.bk3d(this,data.space.bk);}
iv.space.prototype.load=function(data){if(data && data.space){var m=data.space.meshes;var d={objects:[]};if(m)for(var i=0;i<m.length;i++){var obj=new iv.mesh(this.gl);if(this.path)obj.url=this.path+m[i].ref;else obj.url=m[i].ref;d.objects.push(obj);}this.loadImp(data,d);}};iv.space.prototype.renderQueue=function(items){var c=items.length;var a;var gl=this.gl;for(var i=0;i<c;i++){var b=items[i];var d=(b.state&32)!=0;if(d!=a){if(d)gl.disable(gl.CULL_FACE);else gl.enable(gl.CULL_FACE);a=d;}
b.object.render(this,b);};}
iv.space.prototype.updatePrjTM=function(){var V=this.window.view;var gl=this.gl;var bOk=false;var far=0,near=0;for(var iPass=1;iPass<this.q.length;iPass++){var q=this.q[iPass],c=q.L;if(!c)continue;var items=q.I;for(var iO=0;iO<c;iO++){var d=items[iO];if(bOk){if(d.near<near)near=d.near;if(d.far>far)far=d.far;}else{far=d.far;near=d.near;bOk=true};}}
var kx=gl.viewportWidth/gl.viewportHeight;if(V.ortho){var ky=1;kx/=V.scale;ky/=V.scale;mat4.ortho(-kx,kx,-ky,ky,near,far,this.projectionTM);}else{if(bOk){var d=far-near;d/=100;far+=d;near-=d;d=far/1000;if(near<d)near=d;}else{near=0.1;far=100;}
mat4.perspective(V.fov,kx,near,far,this.projectionTM);}};iv.space.prototype.zCompareFunc=function(a,b){var _a=a ? a.near :-1e38,_b=b ? b.near :-1e38;if(_a > _b)return-1;if(_a<_b)return 1;return 0;};iv.space.prototype.prepareLights=function(){var changes=false,_i=this.lights;var d=_i.length-this.currentLight;if(d){_i.splice(this.currentLight,l);changes=true;}
var org=[0,0,0];for(i=0;i<_i.length;i++){var l=_i[i],L=l.light;if(L.type!==l.type){l.type=L.type;changes=true;}
l.color=L.color;if(L.type!=1){if(l.tm)l.org=mat4.mulPoint(l.tm,org,[]);else l.org=org;}if(L.target){if(!l.dir)l.dir=[];if(!l.targetNode||(L.target!=l.tagert))l.targetNode=this.root.searchId(l.tagert=L.target);if(l.targetNode){var wtm=l.targetNode.getWTM();if(wtm)mat4.getTranslate(wtm,l.dir);else vec3.cpy(l.dir,[0,0,0]);vec3.subtractN(l.dir,l.org);}}else{if(l.tm){if(L.dir){l.dir=mat4.mulVector(l.tm,L.dir,[]);vec3.normalize(l.dir);}}else{if(L.dir)l.dir=L.dir;}}if(l.type==2){if(!l.spot)l.spot=[0,0,0];var cin=Math.cos(L.inner/2),cout=Math.cos(L.outer/2);l.spot[0]=cin;l.spot[1]=cout;}}if(changes)this.invalidateMaterials();}
iv.space.prototype.invalidateMaterials=function(){var _i=this.materials;for(var i=0;i<_i.length;i++)_i[i].invalidate();}
iv.space.prototype.render=function(tm){if(this.root){mat4.copy(tm,this.modelviewTM);var gl=this.gl,tmw=mat4.create(),astate=this.cfgRMode<<8,i;mat4.identity(tmw);if(this.cfgDbl)astate|=32;gl.cullFace(gl.BACK);this.currentLight=0;this.root.traverse(tmw,iv.nodeRender,this,astate,1.0);if(!this.stdLights)this.prepareLights();this.updatePrjTM();var blend=false;for(i=1;i<this.q.length;i++){var q=this.q[i],L=q.L;if(!L)continue;var _i=q.I;if(_i.length>q.L)_i.splice(q.L,_i.length-q.L);if(i>3){if(!blend){gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);blend=true;}if(i==7)gl.clear(gl.DEPTH_BUFFER_BIT);_i.sort(this.zCompareFunc);}this.renderQueue(_i);q.L=0;}if(blend)gl.disable(gl.BLEND);this.c2(null);}};iv.queueItem=function(){this.tm=null;this.object=null;this.mtl=null;this.far=this.near=1.0;this.state=0;}
iv.space.prototype.toRenderQueue=function(atm,node,state,opacity){var tm;if(atm)tm=mat4.m_z(atm,this.modelviewTM,this.tmTmp);else tm=this.modelviewTM;var obj=node.object,_min=obj.boxMin,_max=obj.boxMax;var near=-(tm[2]*_min[0]+tm[6]*_min[1]+tm[10]*_min[2]),far=near;for(var i=1;i<8;i++){var x=(i&1)?_max[0]:_min[0],y=(i&2)?_max[1]:_min[1],z=(i&4)?_max[2]:_min[2];z=-(tm[2]*x+tm[6]*y+tm[10]*z);if(z<near)near=z;else if(z>far)far=z;}
z=tm[14];far-=z;near-=z;if(far<1e-6)return;var rmode=this.rmodes[(state&0xff00)>>8],mtl=rmode.mtl||this.cfgDefMtl||node.material;var s=node.stage||((mtl.opacity!=undefined||opacity<1.0)?4:2),_q=this.q[s],a=_q.I[_q.L];if(!mtl.sortId)mtl.sortId=this.mtlSortId++;if(!a)a=_q.I[_q.L]=new iv.queueItem();a.tm=atm;a.object=obj;a.mtl=mtl;a.near=near;a.far=far;a.state=state|(node.state&(16|32|0x30000));a.opacity=opacity;_q.L++;};iv.space.prototype.getMaterial=function(name){var it=this.materials;for(var i=0;i<it.length;i++){var m=it[i];if((m.name!==undefined)&&m.name==name)return m;}return null;}
;iv.mtlchannel=function(){this.mode=0;this.color=null;this.texture=null;}
iv.mtlvar=function(id,ord){this.id=id;this.ord=ord;this.slot=null;}
iv.shader=function(m,f){this.mtl=m;this.flags=f;this.bValid=false;this.attrs=[];this.vars=[];this.textures=[];this.program=null;this.vShader=null;this.fShader=null;this.loadedtextures=0;this.numLights=0;};iv.material=function(space){this.space=space;this.gl=space.gl;this.type="standard";this.shaders=[];this.phong=18;}
iv.mtlchannel.prototype.setColor=function(clr){if(!this.color)this.color=[0,0,0];var c=this.color;var t=typeof clr;if(t==='number'){c[0]=((clr>>16)&0xff)/255;c[1]=((clr>>8)&0xff)/255;c[2]=(clr&0xff)/255;}
else{c[0]=clr[0];c[1]=clr[1];c[2]=clr[2];}}
iv.material.prototype.invalidate=function(){var s=this.shaders;if(s){for(var i=0;i<s.length;i++)s[i].detach(this.gl);this.shaders=[];}}
iv.material.prototype.clear=function(){if(this.diffuse)delete this.diffuse;if(this.specular)delete this.specular;if(this.emissive)delete this.emissive;if(this.reflection)delete this.reflection;if(this.bump)delete this.bump;if(this.opacity)delete this.opacity;if(this.lightmap)delete this.lightmap;this.invalidate();}
iv.material.prototype.isChannel=function(c){if((c===undefined)||(c===null))return false;if(c.length===0)return false;for(var i=0;i<c.length;i++){var item=c[i];if(item.texture!=null||item.color!=null||item.amount!=null)return true;}return false;}
iv.material.prototype.newChannel=function(type,ch){if(!ch)ch=new iv.mtlchannel();if(!(type in this))this[type]=[];this[type].push(ch);this.bValid=false;return ch;}
iv.material.prototype.getChannel=function(type){if(!(type in this))return null;var items=this[type];return items[0];}
iv.material.prototype.newTexture=function(c,name,type){var gl=this.gl;if(type===undefined)type=gl.TEXTURE_2D;c.texture=this.space.getTexture(name,type,this);if(type==gl.TEXTURE_CUBE_MAP)c.wrapT=c.wrapS=gl.CLAMP_TO_EDGE;else
{if(!c.wrapS)c.wrapS=gl.REPEAT;if(!c.wrapT)c.wrapT=gl.REPEAT;}}
iv.material.prototype.cnvTtxMatrix=function(a){var tm=mat3.create();var index=0;for(var i=0;i<3;i++){for(var j=0;j<2;j++){tm[i*3+j]=a[index];index++;}}
tm[2]=0;tm[5]=0;tm[8]=1;return tm;}
iv.material.prototype.loadChannelImp=function(v,name){var c=this.newChannel(name);if(v.color!==undefined)c.setColor(v.color);if(v.amount!==undefined)c.amount=v.amount;if(v.blend)c.blend=v.blend;if(v.texture!==undefined){var type=undefined;if(("type" in v)&&v.type=="cube"){if(this.gl)type=this.gl.TEXTURE_CUBE_MAP;else type=0x8513;}if(v.tm)c.tm=this.cnvTtxMatrix(v.tm);if(v.cmp)c.cmp=v.cmp;if(v.filter)c.filter=v.filter;if(v.uvset)c.uv=v.uvset;else c.uv=0;if(v.wrapT)c.wrapT=v.wrapT;if(v.wrapS)c.wrapS=v.wrapS;this.newTexture(c,v.texture,type);}}
iv.material.prototype.loadChannel=function(v,name){var type=typeof v;if(type==="number"){var c=this.newChannel(name);if(name=='opacity')c.amount=v;else c.setColor(v);}else
if(type==="object"){if(v instanceof Array){var len=v.length;if((len==3)&&(typeof v[0]=='number')&&(typeof v[1]=='number')&&(typeof v[2]=='number')){var c=this.newChannel(name);c.setColor(v);}else{for(var i=0;i<len;i++)this.loadChannelImp(v[i],name);}}else this.loadChannelImp(v,name);}};iv.material.prototype.load=function(d){for(var v in d){var a=d[v];switch(v){case "lightmap":
case "diffuse":
case "specular":
case "emissive":
case "reflection":
case "opacity":
case "bump":this.loadChannel(a,v);break;case "ambient":this.loadChannel(a,"emissive");break;case "name":
case "phong":
case "backSide":
case "path":this[v]=a;break;}}return true;}
iv.material.prototype.getShader=function(flags){flags&=~256;if(!this.space.cfgTextures)flags&=~2;for(var i=0;i<this.shaders.length;i++){var s=this.shaders[i];if(s.flags==flags){if((s.loadedtextures!=s.textures.length)&& s.bValid){var c=s.readyTextures(false);if(c!=s.loadedtextures)s.bValid=false;}if(s.numLights!=this.space.lights.length)s.bValid=false;return s;}}
var s=new iv.shader(this,flags);this.shaders.push(s);return s;}
iv.shader.prototype.addVar=function(id,ord){var v=new iv.mtlvar(id,ord);this.vars.push(v);return v;}
iv.shader.prototype.addAttr=function(id,shName,gl){var attr={};attr.id=id;attr.slot=gl.getAttribLocation(this.program,shName);gl.enableVertexAttribArray(attr.slot);this.attrs.push(attr);}
iv.shader.prototype.addLightVar=function(id,name,light,ord){var v=this.addVar(id,ord);v.name=name;v.light=light;return v;}
iv.shader.prototype.addChVar=function(id,name,ch,ord){var v=this.addVar(id,ord);v.name=name;v.channel=ch;return v;}
iv.shader.prototype.compareTM3=function(a,b){if(a===undefined && b===undefined)return true;if(a===undefined||b===undefined)return false;for(var i=0;i<9;i++)if(Math.abs(a[i]-b[i])>1e-4)return false;return true;}
iv.shader.prototype.getTexture=function(c){var items=this.textures;for(var j=0;j<items.length;j++){var t=items[j];if(t.txt===c.texture &&(t.wrapS==c.wrapS)&&(t.wrapT==c.wrapT)&& this.compareTM3(t.tm,c.tm)&& c.uv==t.uv)return t;}return null;}
iv.shader.prototype.preChannel=function(ch,ft){var text="";for(var i=0;i<ch.length;i++){var c=ch[i];c._id=this.channelId;this.channelId++;if(c.color!=null){var name="ch"+c._id+"clr";this.addChVar("color",name,c,4102);text+="uniform vec3 "+name+";\r\n";}if("amount" in c){var name="ch"+c._id+"amount";this.addChVar("amount",name,c,4104);text+="uniform float "+name+";\r\n";}}
ft.push(text);};iv.shader.prototype.handleChannel_=function(gl,ch,ft){var text="";var text2="";for(var i=0;i<ch.length;i++){var c=ch[i];var cname=null;var tname=null;var aname=null;if(c.color!=null){cname="ch"+c._id+"clr";}if(c.texture!=null && c.texture.ivready){var t=this.getTexture(c);if(t){if(c.texture.ivtype==gl.TEXTURE_CUBE_MAP){text+="vec3 lup=reflect(eyeDirection,normal);lup.y*=-1.0;vec4 refColor="+"textureCube(txtUnit"+t.slot+",lup);";tname="refColor";}else{tname="txtColor"+t.slot;}}}if(tname && c.amount!=null){aname="ch"+c._id+"amount";}if(cname||tname){var local=null;if(aname && tname)local="vec3("+aname+")*vec3("+tname+")";else
if(cname && tname)local=cname+"*vec3("+tname+")";else
if(cname)local=cname;else local="vec3("+tname+")";if(text2.length){text2="("+text2+")"+this.getBlend(c)+local;}else text2=local;}}if(text.length)ft.push(text+"\r\n");return text2;}
iv.shader.prototype.handleChannel=function(gl,ch,cmp,ft){var text2=this.handleChannel_(gl,ch,ft);if(text2){if(cmp)text2=cmp+"*="+text2;else text2="color+="+text2;ft.push(text2+";");}if(cmp)ft.push("color+="+cmp+";");};iv.shader.prototype.getBlend=function(c){var blend;switch(c.blend){case "sub": blend="-";break;case "mul": blend="*";break;default: blend="+";break;}return blend;}
iv.shader.prototype.handleAlphaChannel=function(gl,ch,ft){if(ch && ch.length){var txt=null;var tAlpha=false;for(var i=0;i<ch.length;i++){var c=ch[i];var tname=null;var aname=null;if(c.texture && c.texture.ivready){var t=this.getTexture(c);if(t)tname="txtColor"+t.slot;}if(c.amount!=null){aname="ch"+c._id+"amount";}if(tname){if(aname)t=aname+"*";else t="";if(c.cmp && c.cmp=='a')t+=tname+".a";else
t+="("+tname+".x+"+tname+".y+"+tname+".z)/3.0";}else
if(aname)t=aname;if(t){if(txt){if(!tAlpha){txt="float alpha="+txt+";\n";tAlpha=true;}
txt+="alpha"+this.getBlend(c)+'='+t+";\n";}else txt=t;}}if(txt){if(tAlpha){ft.push(txt);return "alpha";}else return txt;}}return "1.0";}
iv.shader.prototype.handleBumpChannel=function(gl,ch){if(ch && ch.length){var c=ch[0];if(c.texture && c.texture.ivready){var t=this.getTexture(c);if(t){var tname="txtColor"+t.slot;var text="\r\nvec3 _n=vec3("+tname+");";text+="_n-=vec3(0.5,0.5,0);_n*=vec3(2.0,2.0,1.0);";if(c.amount!=null){var aname="ch"+c._id+"amount";text+="_n*=vec3("+aname+","+aname+",1.0);";}
text+="_n=normalize(_n);";return text;}}}return null;}
iv.shader.prototype.c0=function(ch,f){var rez=0;if(ch){for(var i=0;i<ch.length;i++){var c=ch[i];if(c.texture&&((f<0)||(f&(1<<c.uv)))){if(!this.getTexture(c)){var t={"txt":c.texture,"slot":0,"wrapS":c.wrapS,"wrapT":c.wrapT,uv:c.uv?c.uv:0};if(c.tm){t.tm=c.tm;t.ch=c;}this.textures.push(t);}if(c.texture.ivready)rez|=1<<c.uv;}}}return rez;}
iv.shader.prototype.readyTextures=function(bSet){var c=0;for(var i=0;i<this.textures.length;i++){var t=this.textures[i];if(t.txt.ivready){if(bSet)t.slot=c;c++;}}return c;}
iv.shader.prototype.compile=function(gl,i,type){var str=i.join('');var shader=gl.createShader(type);gl.shaderSource(shader,str);gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){alert(str+"\r\n"+gl.getShaderInfoLog(shader));return null;}return shader;}
iv.shader.prototype.fetchTextures=function(gl,ft){var _i=this.textures;var a=0;for(i=0;i<_i.length;i++){var t=_i[i];if(t.txt.ivready && t.txt.ivtype==gl.TEXTURE_2D){if(t.tm){var s="_uv=vec2(ch"+t.ch._id+"tm*vec3(vUV"+t.uv+",1.0));\n";ft.push((a?"":"vec2 ")+s);a++;}
ft.push("vec4 txtColor"+t.slot+"=texture2D(txtUnit"+t.slot+","+((t.tm)?"_uv":"vUV"+t.uv)+");");}}}
iv.shader.prototype.update=function(mtl){mtl=this.mtl;if(this.program)this.detach(mtl.gl);this.numLights=mtl.space.lights.length;this.channelId=0;var gl=mtl.gl,i;var _lights=null;var vt=[];var ft=[];if(this.flags&8)vt.push("uniform mat4 tmWorld;uniform mat4 tmModelView;uniform mat4 tmPrj;");if(this.flags&iv.R_Z_OFFSET)vt.push("uniform float zOffset;");var bN=(this.flags&1)!=0,bSpecular=false,bDiffuse=false,bLights=false,bReflection=false,bBump=false,bLightMap=false;var bEmissive=mtl.isChannel(mtl.emissive);var bOpacity=mtl.isChannel(mtl.opacity)||(this.flags&1024);var lights=mtl.space.lights;vt.push("attribute vec3 inV;");if(this.flags&8)vt.push("varying vec4 wPosition;");if(this.flags&4)vt.push("varying vec3 vC;attribute vec3 inC;");if(this.flags&64)vt.push("varying vec3 vCE;attribute vec3 inCE;");var bUV=0;if(bN){vt.push("varying vec3 wNormal;attribute vec3 inN;");if(lights.length){if(mtl.isChannel(mtl.diffuse))bDiffuse=true;if(mtl.isChannel(mtl.specular))bSpecular=true;bLights=bDiffuse||bSpecular;}if(mtl.space.cfgTextures)bReflection=this.c0(mtl.reflection,-1);}
var _uvflags=0;if(this.flags&2)_uvflags|=1;if(this.flags&32)_uvflags|=2;if(_uvflags){if(bDiffuse)bUV|=this.c0(mtl.diffuse,_uvflags);if(bSpecular)bUV|=this.c0(mtl.specular,_uvflags);if(bEmissive)bUV|=this.c0(mtl.emissive,_uvflags);if(bOpacity)bUV|=this.c0(mtl.opacity,_uvflags);if(bN && bLights)bUV|=(bBump=this.c0(mtl.bump,_uvflags));bUV|=(bLightMap=this.c0(mtl.lightmap,_uvflags));}if(bUV&1)vt.push("varying vec2 vUV0;attribute vec2 inUV0;");if(bUV&2)vt.push("varying vec2 vUV1;attribute vec2 inUV1;");if(bBump){vt.push("varying vec3 vBN,vBT;attribute vec3 inBN,inBT;");}this.loadedtextures=this.readyTextures(true);vt.push("\r\nvoid main(void){\r\n");if(this.flags&8){vt.push("wPosition=tmWorld*vec4(inV,1.0);vec4 vPosition=tmModelView*wPosition;gl_Position=tmPrj*vPosition;");this.addVar("tmWorld",4101);this.addVar("tmModelView",4114);this.addVar("tmPrj",4115);}
else vt.push("gl_Position=vec4(inV,1.0);");if(this.flags&iv.R_Z_OFFSET){this.addVar("zOffset",4105);vt.push("gl_Position.z+=zOffset;");}if(bN){vt.push("wNormal=");if(mtl.backSide)vt.push("-");vt.push("normalize(vec3(tmWorld*vec4(inN,0.0)));");}if(bBump)vt.push("vBN=normalize(vec3(tmWorld*vec4(inBN,0.0)));vBT=normalize(vec3(tmWorld*vec4(inBT,0.0)));");if(bUV&1)vt.push("vUV0=inUV0;");if(bUV&2)vt.push("vUV1=inUV1;");if(this.flags&4)vt.push("vC=inC;");if(this.flags&64)vt.push("vCE=inCE;");vt.push("}");ft.push("precision mediump float;");if(this.flags&1024)ft.push("uniform float opacity;");if(bN)ft.push("varying vec4 wPosition;");if(this.flags&4)ft.push("varying vec3 vC;");if(this.flags&64)ft.push("varying vec3 vCE;");if(bUV&1)ft.push("varying vec2 vUV0;");if(bUV&2)ft.push("varying vec2 vUV1;");if(bBump)ft.push("varying vec3 vBN,vBT;");if(bDiffuse)this.preChannel(mtl.diffuse,ft);if(bSpecular)this.preChannel(mtl.specular,ft);if(bEmissive)this.preChannel(mtl.emissive,ft);if(bReflection)this.preChannel(mtl.reflection,ft);if(bOpacity&& mtl.opacity)this.preChannel(mtl.opacity,ft);if(bBump)this.preChannel(mtl.bump,ft);for(i=0;i<this.textures.length;i++){var t=this.textures[i];if(t.txt.ivready){ft.push("uniform ");if(t.txt.ivtype==gl.TEXTURE_CUBE_MAP)ft.push("samplerCube");else
ft.push("sampler2D");ft.push(" txtUnit"+t.slot+";");if(t.tm){var v=this.addVar("tm",4103);v.channel=t.ch;ft.push("uniform mat3 ch"+t.ch._id+"tm;");}}}if(bN){ft.push("uniform vec3 eye;");this.addVar("eye",4113);if(bSpecular){ft.push("uniform float mtlPhong;");this.addVar("mtlPhong",4116);}
ft.push("varying vec3 wNormal;");ft.push("float k;");if(bLights){ft.push("vec3 diffuse,specular,lightDir;");_lights=[];var bAnySpot=false;for(i=0;i<lights.length;i++){var ls=lights[i];var l={};l.light=ls;var colorname="light"+i+"Clr";ft.push("uniform vec3 "+colorname+";");l.colorname=colorname;this.addLightVar("lightColor",colorname,ls,4110);if(ls.dir){var dirname="light"+i+"Dir";l.dirname=dirname;ft.push("uniform vec3 "+dirname+";");this.addLightVar("lightDir",dirname,ls,4112);}if(ls.spot){bAnySpot=true;l.spotname="light"+i+"Spot";ft.push("uniform vec3 "+l.spotname+";");this.addLightVar("lightSpot",l.spotname,ls,4117);}if(ls.org){l.orgname="light"+i+"Org";ft.push("uniform vec3 "+l.orgname+";");this.addLightVar("lightOrg",l.orgname,ls,4111);}
_lights.push(l);}if(bAnySpot)ft.push("float angle;");}}
ft.push("\nvoid main(void){\r\n");this.fetchTextures(gl,ft);if(bN){ft.push("vec3 normal=normalize(wNormal);");var normalSign="";if(this.flags&512){ft.push("vec3 normalSign=vec3(gl_FrontFacing?1.0:-1.0);");normalSign="normalSign*";}if(bBump){var txt=this.handleBumpChannel(gl,mtl.bump);if(txt){ft.push(txt);ft.push("mat3 tsM=mat3(normalize("+normalSign+"vBN),normalize("+normalSign+"vBT),normal);");ft.push("normal=normalize(tsM*_n);");}}if(this.flags&512)ft.push("normal="+normalSign+"normal;");ft.push("vec3 eyeDirection=normalize(wPosition.xyz-eye);vec3 reflDir;float specA;");if(_lights)for(i=0;i<_lights.length;i++){var l=_lights[i];var dirName;var kstr="k*";switch(l.light.type){case 0:ft.push("lightDir=normalize(wPosition.xyz-"+l.orgname+");");dirName="lightDir";break;case 1:dirName=l.dirname;break;case 2:
ft.push("lightDir=normalize(wPosition.xyz-"+l.orgname+");");ft.push("angle=smoothstep("+l.spotname+"[1],"+l.spotname+"[0],dot(lightDir,"+l.dirname+"));");kstr="k*angle*";dirName="lightDir";break;}if(bSpecular){ft.push("reflDir=reflect(-"+dirName+",normal);");ft.push("specA=dot(reflDir,eyeDirection);");ft.push("k=pow(max(specA,0.0),mtlPhong);");if(i)ft.push("specular+=");else ft.push("specular=");ft.push(kstr+l.colorname+";");}if(bDiffuse){ft.push("k=max(dot(normal,-"+dirName+"),0.0);");if(i)ft.push("diffuse+=");else ft.push("diffuse=");ft.push(kstr+l.colorname+";");}}}
ft.push("vec3 color=vec3(0.0,0.0,0.0);\r\n");if(this.flags&4){if(bDiffuse &&(!(this.flags&64)))ft.push("diffuse=diffuse*vC;");else
{ft.push("color+=vC;");bEmissive=false;}}if(this.flags&64)ft.push("color+=vCE;");if(bDiffuse)this.handleChannel(gl,mtl.diffuse,"diffuse",ft);if(bSpecular)this.handleChannel(gl,mtl.specular,"specular",ft);if(bLightMap){var aoText=this.handleChannel_(gl,mtl.lightmap,ft);if(aoText)ft.push("color*="+aoText+";");}if(bEmissive)this.handleChannel(gl,mtl.emissive,null,ft);var alpha="1.0";if(bOpacity){var n;if(this.flags&1024)this.addVar("opacity",4106);if(mtl.opacity){n=this.handleAlphaChannel(gl,mtl.opacity,ft);if(this.flags&1024){ft.push("float _opacity=opacity*"+n+";");n="_opacity";}}else n="opacity";if(bReflection){var text2=this.handleChannel_(gl,mtl.reflection,ft);ft.push("vec3 _refColor="+text2+";");ft.push("float _refA=(_refColor.x+_refColor.y+_refColor.z)/3.0;");ft.push("_refA=1.0-(1.0-_refA)*(1.0-"+n+");");n="_refA";ft.push("color+=_refColor;");}else ft.push("if("+n+"<0.004)discard;");ft.push("gl_FragColor=vec4(color,"+n+");");}else{if(bReflection)this.handleChannel(gl,mtl.reflection,null,ft);ft.push("gl_FragColor=vec4(color,1.0);");}
ft.push("}");this.vShader=this.compile(gl,vt,gl.VERTEX_SHADER);this.fShader=this.compile(gl,ft,gl.FRAGMENT_SHADER);var shPrg=gl.createProgram();this.program=shPrg;gl.attachShader(shPrg,this.vShader);gl.attachShader(shPrg,this.fShader);gl.linkProgram(shPrg);if(!gl.getProgramParameter(shPrg,gl.LINK_STATUS)){alert("Could not initialise shaders");}
gl.useProgram(shPrg);this.addAttr(4300,"inV",gl);if(bN)this.addAttr(4301,"inN",gl);if(bUV&1)this.addAttr(4302,"inUV0",gl);if(bUV&2)this.addAttr(4306,"inUV1",gl);if(bBump){this.addAttr(4303,"inBN",gl);this.addAttr(4304,"inBT",gl);}if(this.flags&4)this.addAttr(4305,"inC",gl);if(this.flags&64)this.addAttr(4307,"inCE",gl);for(i=0;i<this.textures.length;i++){var t=this.textures[i];if(t.txt.ivready){t.uniform=gl.getUniformLocation(shPrg,"txtUnit"+t.slot);}}
for(i=0;i<this.vars.length;i++){var v=this.vars[i];var name=null;switch(v.id){case "tm":name="ch"+v.channel._id+"tm";break;case "color":name="ch"+v.channel._id+"clr";break;case "amount":name="ch"+v.channel._id+"amount";break;case "lightSpot":
case "lightColor":
case "lightDir":
case "lightOrg":name=v.name;break;default:name=v.id;}
v.slot=gl.getUniformLocation(shPrg,name);if(!v.slot)console.log("Slot '"+name+"' not found");}this.bValid=true;return true;}
iv.shader.prototype.detach=function(gl){if(this.program!==null){gl.detachShader(this.program,this.vShader);gl.detachShader(this.program,this.fShader);gl.deleteProgram(this.program);gl.deleteShader(this.vShader);gl.deleteShader(this.fShader);this.program=null;this.fShader=null;this.vShader=null;}this.attrs=[];this.vars=[];this.textures=[];this.loadedtextures=0;}
iv.shader.prototype.activate=function(space,info,flags,newObj){var mtl=this.mtl;var gl=mtl.gl,i;if(!newObj){gl.useProgram(this.program);for(i=0;i<this.textures.length;i++){var t=this.textures[i];if(t.txt.ivready){gl.activeTexture(gl.TEXTURE0+t.slot);var type=t.txt.ivtype;gl.bindTexture(type,t.txt);if(type==gl.TEXTURE_2D && space.e_ans &&(t.txt.filter==iv.FILTER_MIPMAP))gl.texParameterf(type,space.e_ans.TEXTURE_MAX_ANISOTROPY_EXT,space.e_ansMax);gl.texParameteri(type,gl.TEXTURE_WRAP_S,t.wrapS);gl.texParameteri(type,gl.TEXTURE_WRAP_T,t.wrapT);gl.uniform1i(t.uniform,t.slot);}}}
var _i=this.vars;for(i=0;i<_i.length;i++){var a=_i[i],s=a.slot;switch(a.ord){case 4101:gl.uniformMatrix4fv(s,false,info.tm);break;case 4102:{var c=a.channel.color;if(flags&256)c=vec3.lerp_r(c,space.clrSelection,0.5);gl.uniform3fv(s,c);}break;case 4103:gl.uniformMatrix3fv(s,false,a.channel.tm);break;case 4104:gl.uniform1f(s,a.channel.amount);break;case 4105:gl.uniform1f(s,-0.02);break;case 4106:gl.uniform1f(s,info.opacity);break;default:
if(!newObj){switch(a.ord){case 4110:gl.uniform3fv(s,a.light.color);break;case 4111:gl.uniform3fv(s,a.light.org);break;case 4112:gl.uniform3fv(s,a.light.dir);break;case 4113:gl.uniform3fv(s,space.window.view.from);break;case 4114:gl.uniformMatrix4fv(s,false,space.modelviewTM);break;case 4115:gl.uniformMatrix4fv(s,false,space.projectionTM);break;case 4116:gl.uniform1f(s,mtl.phong);break;case 4117:gl.uniform3fv(s,a.light.spot);break;}}}}}
;iv.node=function(){this.object=null;this.tm=null;this.name="";this.material=null;this.state=3;this.ref=0;}
iv.node.prototype.addRef=function(){this.ref++;}
iv.node.prototype.release=function(){this.ref--;if(this.ref<1)this.clear();}
iv.node.prototype.newNode=function(){return this.insert(new iv.node());}
iv.node.prototype.insert=function(n){n.ref++;if(this.lastChild)this.lastChild.next=n;else
this.firstChild=n;this.lastChild=n;n.parent=this;return n;}
iv.node.prototype.clear=function(){while(this.firstChild)this.remove(this.firstChild);this.setObject(null);}
iv.node.prototype.remove=function(n){if(n.parent!=this)return false;var _n=null;if(this.firstChild==n){this.firstChild=n.next;}else
{_n=this.firstChild;while(_n){if(_n.next==n){_n.next=n.next;break;}
_n=_n.next;}}if(this.lastChild==n)this.lastChild=_n;n.parent=null;n.next=null;n.release();return true;}
iv.node.prototype.setState=function(s,mask){var _state=this.state&(~mask)|mask&s;if(_state!=this.state){this.state=_state;return true;}return false;}
iv.node.prototype.traverse=function(ptm,proc,param,astate,opacity){var v=this.state;astate|=(v&4);if(v&0xff00){astate&=~0xff00;astate|=v&0xff00;}if(!(v&3))return;if(this.cull){if(this.cull===1)astate|=32;else astate&=~32;}if(this.tm){if(ptm){if(!this.wtm)this.wtm=mat4.create();ptm=mat4.m(this.tm,ptm,this.wtm);}else ptm=this.tm;};if(this.opacity!==undefined && opacity!==undefined)opacity*=this.opacity;if(v&1 &&(!proc(this,ptm,param,astate,opacity)))return;if(v&2){var child=this.firstChild;while(child){child.traverse(ptm,proc,param,astate,opacity);child=child.next;}}};iv.node.prototype.setObject=function(obj){if(this.object!=obj){if(this.object)this.object.release();this.object=obj;if(obj)obj.ref++;}}
iv.node.prototype.load=function(d,info){var i,j,a,v;for(v in d){a=d[v];switch(v){case 'light':this.setObject(new iv.light(a));break;case 'camera':this.setObject(new iv.camera(a));break;case 'object':this.setObject(info.objects[a]);break;case 'mtl':a=info.materials[a];if(a){this.material=a;if(a.bump && this.object)this.object.bump=true;}break;case 's':this.state=a;break;case 'tm':
this.tm=mat4.create();mat4.identity(this.tm);var index=0;for(i=0;i<4;i++){for(j=0;j<3;j++){this.tm[i*4+j]=d.tm[index];index++;}}
break;case 'i':for(i=0;i<a.length;i++)this.newNode().load(a[i],info);break;default:this[v]=a;}}}
iv.nodeRender=function(node,tm,space,state,opacity){if(node.object)node.object.preRender(node,tm,space,state,opacity);return true;};iv.node.prototype.enableTM=function(){if(!this.tm)this.tm=mat4.identity(mat4.create());return this.tm;}
iv.node.prototype.getWTM=function(){var tm=null;var n=this;while(n){if(n.tm){if(tm){mat4.m(tm,n.tm);}else tm=mat4.create(n.tm);}
n=n.parent;}return tm;};iv.node.prototype.searchId=function(id){if(this.id==id)return this;var n=this.firstChild;while(n){var _n=n.searchId(id);if(_n)return _n;n=n.next;}return null;}
;var ZIP={MASK_BITS:[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],cplens:[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],cplext:[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99],cpdist:[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],cpdext:[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],b:[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],inflateBin:function(c,b){var a=new zip(c);return a.inflateBin(b)},inflateStr:function(c,b){var a=new zip(c);return a.inflateStr(b)}};function zip(a){this.WSIZE=32768;this.LBITS=9;this.DBITS=6;this.slide=new Array(2*this.WSIZE);this.wp=0;this.bitBuf=0;this.bitLen=0;this.method=-1;this.eof=false;this.copyLen=this.zip_copy_dist=0;this.tl=null;this.pos=0;this.src=a;this.STORED_BLOCK=0;this.fixedTL=null}function zip_HuftList(){this.next=null;this.list=null}function zip_HuftNode(){this.e=0;this.b=0;this.n=0;this.t=null}function zip_HuftBuild(P,L,D,R,S,X){this.BMAX=16;this.N_MAX=288;this.status=0;this.root=null;this.m=0;var O;var Q=new Array(this.BMAX+1);var V;var T;var U;var H;var I;var J;var K;var A=new Array(this.BMAX+1);var N;var W;var B;var C=new zip_HuftNode();var E=new Array(this.BMAX);var F=new Array(this.N_MAX);var G;var l=new Array(this.BMAX+1);var Y;var m;var t;var M;var Z;Z=this.root=null;for(I=0;I<Q.length;I++){Q[I]=0}for(I=0;I<A.length;I++){A[I]=0}for(I=0;I<E.length;I++){E[I]=null}for(I=0;I<F.length;I++){F[I]=0}for(I=0;I<l.length;I++){l[I]=0}V=L>256?P[256]:this.BMAX;N=P;W=0;I=L;do{Q[N[W]]++;W++}while(--I>0);if(Q[0]==L){this.root=null;this.m=0;this.status=0;return}for(J=1;J<=this.BMAX;J++){if(Q[J]!=0){break}}K=J;if(X<J){X=J}for(I=this.BMAX;I!=0;I--){if(Q[I]!=0){break}}U=I;if(X>I){X=I}for(m=1<<J;J<I;J++,m<<=1){if((m-=Q[J])<0){this.status=2;this.m=X;return}}if((m-=Q[I])<0){this.status=2;this.m=X;return}Q[I]+=m;l[1]=J=0;N=Q;W=1;Y=2;while(--I>0){l[Y++]=(J+=N[W++])}N=P;W=0;I=0;do{if((J=N[W++])!=0){F[l[J]++]=I}}while(++I<L);L=l[U];l[0]=I=0;N=F;W=0;H=-1;G=A[0]=0;B=null;t=0;for(;K<=U;K++){O=Q[K];while(O-->0){while(K>G+A[1+H]){G+=A[1+H];H++;t=(t=U-G)>X?X:t;if((T=1<<(J=K-G))>O+1){T-=O+1;Y=K;while(++J<t){if((T<<=1)<=Q[++Y]){break}T-=Q[Y]}}if(G+J>V&&G<V){J=V-G}t=1<<J;A[1+H]=J;B=new Array(t);for(M=0;M<t;M++){B[M]=new zip_HuftNode()}if(Z==null){Z=this.root=new zip_HuftList()}else{Z=Z.next=new zip_HuftList()}Z.next=null;Z.list=B;E[H]=B;if(H>0){l[H]=I;C.b=A[H];C.e=16+J;C.t=B;J=(I&((1<<G)-1))>>(G-A[H]);E[H-1][J].e=C.e;E[H-1][J].b=C.b;E[H-1][J].n=C.n;E[H-1][J].t=C.t}}C.b=K-G;if(W>=L){C.e=99}else{if(N[W]<D){C.e=(N[W]<256?16:15);C.n=N[W++]}else{C.e=S[N[W]-D];C.n=R[N[W++]-D]}}T=1<<(K-G);for(J=I>>G;J<t;J+=T){B[J].e=C.e;B[J].b=C.b;B[J].n=C.n;B[J].t=C.t}for(J=1<<(K-1);(I&J)!=0;J>>=1){I^=J}I^=J;while((I&((1<<G)-1))!=l[H]){G-=A[H];H--}}}this.m=A[1];this.status=((m!=0&&U!=1)?1:0)}zip.prototype.getByte=function(){var a=this.src.byteLength;if(a==this.pos){return-1}return this.src.getUint8(this.pos++)};zip.prototype.needBits=function(a){while(this.bitLen<a){this.bitBuf|=this.getByte()<<this.bitLen;this.bitLen+=8}};zip.prototype.getBits=function(a){return this.bitBuf&ZIP.MASK_BITS[a]};zip.prototype.dumpBits=function(a){this.bitBuf>>=a;this.bitLen-=a};zip.prototype.inflateCodes=function(b,c,a){var g;var d;var f;if(a==0){return 0}f=0;for(;;){this.needBits(this.zip_bl);d=this.tl.list[this.getBits(this.zip_bl)];g=d.e;while(g>16){if(g==99){return-1}this.dumpBits(d.b);g-=16;this.needBits(g);d=d.t[this.getBits(g)];g=d.e}this.dumpBits(d.b);if(g==16){this.wp&=this.WSIZE-1;b[c+f++]=this.slide[this.wp++]=d.n;if(f==a){return a}continue}if(g==15){break}this.needBits(g);this.copyLen=d.n+this.getBits(g);this.dumpBits(g);this.needBits(this.zip_bd);d=this.zip_td.list[this.getBits(this.zip_bd)];g=d.e;while(g>16){if(g==99){return-1}this.dumpBits(d.b);g-=16;this.needBits(g);d=d.t[this.getBits(g)];g=d.e}this.dumpBits(d.b);this.needBits(g);this.zip_copy_dist=this.wp-d.n-this.getBits(g);this.dumpBits(g);while(this.copyLen>0&&f<a){this.copyLen--;this.zip_copy_dist&=this.WSIZE-1;this.wp&=this.WSIZE-1;b[c+f++]=this.slide[this.wp++]=this.slide[this.zip_copy_dist++]}if(f==a){return a}}this.method=-1;return f};zip.prototype.inflateStored=function(b,a,c){var d;d=this.bitLen&7;this.dumpBits(d);this.needBits(16);d=this.getBits(16);this.dumpBits(16);this.needBits(16);if(d!=((~this.bitBuf)&65535)){return-1}this.dumpBits(16);this.copyLen=d;d=0;while(this.copyLen>0&&d<c){this.copyLen--;this.wp&=this.WSIZE-1;this.needBits(8);b[a+d++]=this.slide[this.wp++]=this.getBits(8);this.dumpBits(8)}if(this.copyLen==0){this.method=-1}return d};zip.prototype.inflateFixed=function(b,c,a){if(this.fixedTL==null){var f;var d=new Array(288);var e;for(f=0;f<144;f++){d[f]=8}for(;f<256;f++){d[f]=9}for(;f<280;f++){d[f]=7}for(;f<288;f++){d[f]=8}this.zip_fixed_bl=7;e=new zip_HuftBuild(d,288,257,ZIP.cplens,ZIP.cplext,this.zip_fixed_bl);if(e.status!=0){alert("HufBuild error: "+e.status);return-1}this.fixedTL=e.root;this.zip_fixed_bl=e.m;for(f=0;f<30;f++){d[f]=5}this.zip_fixed_bd=5;e=new zip_HuftBuild(d,30,0,ZIP.cpdist,ZIP.cpdext,this.zip_fixed_bd);if(e.status>1){this.fixedTL=null;alert("HufBuild error: "+e.status);return-1}this.zip_fixed_td=e.root;this.zip_fixed_bd=e.m}this.tl=this.fixedTL;this.zip_td=this.zip_fixed_td;this.zip_bl=this.zip_fixed_bl;this.zip_bd=this.zip_fixed_bd;return this.inflateCodes(b,c,a)};zip.prototype.inflateDynamic=function(p,m,a){var f;var g;var k;var o;var d;var c;var r;var q;var b=new Array(286+30);var e;for(f=0;f<b.length;f++){b[f]=0}this.needBits(5);r=257+this.getBits(5);this.dumpBits(5);this.needBits(5);q=1+this.getBits(5);this.dumpBits(5);this.needBits(4);c=4+this.getBits(4);this.dumpBits(4);if(r>286||q>30){return-1}for(g=0;g<c;g++){this.needBits(3);b[ZIP.b[g]]=this.getBits(3);this.dumpBits(3)}for(;g<19;g++){b[ZIP.b[g]]=0}this.zip_bl=7;e=new zip_HuftBuild(b,19,19,null,null,this.zip_bl);if(e.status!=0){return-1}this.tl=e.root;this.zip_bl=e.m;o=r+q;f=k=0;while(f<o){this.needBits(this.zip_bl);d=this.tl.list[this.getBits(this.zip_bl)];g=d.b;this.dumpBits(g);g=d.n;if(g<16){b[f++]=k=g}else{if(g==16){this.needBits(2);g=3+this.getBits(2);this.dumpBits(2);if(f+g>o){return-1}while(g-->0){b[f++]=k}}else{if(g==17){this.needBits(3);g=3+this.getBits(3);this.dumpBits(3);if(f+g>o){return-1}while(g-->0){b[f++]=0}k=0}else{this.needBits(7);g=11+this.getBits(7);this.dumpBits(7);if(f+g>o){return-1}while(g-->0){b[f++]=0}k=0}}}}this.zip_bl=this.LBITS;e=new zip_HuftBuild(b,r,257,ZIP.cplens,ZIP.cplext,this.zip_bl);if(this.zip_bl==0){e.status=1}if(e.status!=0){if(e.status==1){}return-1}this.tl=e.root;this.zip_bl=e.m;for(f=0;f<q;f++){b[f]=b[f+r]}this.zip_bd=this.DBITS;e=new zip_HuftBuild(b,q,0,ZIP.cpdist,ZIP.cpdext,this.zip_bd);this.zip_td=e.root;this.zip_bd=e.m;if(this.zip_bd==0&&r>257){return-1}if(e.status==1){}if(e.status!=0){return-1}return this.inflateCodes(p,m,a)};zip.prototype.inflateInternal=function(c,a,d){var e,b;e=0;while(e<d){if(this.eof&&this.method==-1){return e}if(this.copyLen>0){if(this.method!=this.STORED_BLOCK){while(this.copyLen>0&&e<d){this.copyLen--;this.zip_copy_dist&=this.WSIZE-1;this.wp&=this.WSIZE-1;c[a+e++]=this.slide[this.wp++]=this.slide[this.zip_copy_dist++]}}else{while(this.copyLen>0&&e<d){this.copyLen--;this.wp&=this.WSIZE-1;this.needBits(8);c[a+e++]=this.slide[this.wp++]=this.getBits(8);this.dumpBits(8)}if(this.copyLen==0){this.method=-1}}if(e==d){return e}}if(this.method==-1){if(this.eof){break}this.needBits(1);if(this.getBits(1)!=0){this.eof=true}this.dumpBits(1);this.needBits(2);this.method=this.getBits(2);this.dumpBits(2);this.tl=null;this.copyLen=0}switch(this.method){case 0:b=this.inflateStored(c,a+e,d-e);break;case 1:if(this.tl!=null){b=this.inflateCodes(c,a+e,d-e)}else{b=this.inflateFixed(c,a+e,d-e)}break;case 2:if(this.tl!=null){b=this.inflateCodes(c,a+e,d-e)}else{b=this.inflateDynamic(c,a+e,d-e)}break;default:b=-1;break}if(b==-1){if(this.eof){return 0}return-1}e+=b}return e};zip.prototype.inflateStr=function(c){var k,e;var m=-1;var d=new Array(1024);var f="";var l=0,h=0;while((k=this.inflateInternal(d,0,d.length))>0&&m!=this.pos){m=this.pos;for(e=0;e<k;e++){var g=d[e];if(l){l--;h|=(g&63)<<(l*6);if(!l){f+=String.fromCharCode(h)}}else{if(g<128){f+=String.fromCharCode(g)}else{if(g<224){l=1;h=(g&65567)<<6}else{if(g<240){l=2;h=(g&65567)<<12}else{if(g<248){l=3;h=(g&65543)<<18}else{if(g<252){l=4;h=(g&65543)<<18}else{if(g<254){l=5;h=(g&65537)<<30}else{f+=String.fromCharCode(g)}}}}}}}}}return f};zip.prototype.inflateBin=function(a){var b,c=0;var f=-1;var d=new ArrayBuffer(a);var e=new Uint8Array(d);while((b=this.inflateInternal(e,c=0,e.length))>0&&f!=this.pos){f=this.pos;c+=b}return d};;iv.object=function(){this.ref=0;}
iv.object.prototype.clear=function(){}
iv.object.prototype.addRef=function(){this.ref++;}
iv.object.prototype.release=function(){this.ref--;if(this.ref<1)this.clear();}
iv.object.prototype.preRender=function(node,tm,space,state,opacity){return true;}
iv.object.prototype.hitTest=function(tm,info,org,dir){return false;}
iv.object.prototype.preHitTest=function(tm,info){return false;}
iv.light=function(d){this.type=0;this.dir=null;this.org=null;if(d)this.load(d);}
iv.light.prototype=new iv.object();iv.light.prototype.load=function(d){for(var v in d){var a=d[v];switch(v){case 'dir':
case 'org':this[v]=a.slice();break;default:this[v]=a;}}}
iv.light.prototype.preRender=function(node,tm,space,state,opacity){if(!space.stdLights){var l=space.lights[space.currentLight];if(!l)space.lights.push(l={});l.tm=tm;l.light=this;space.currentLight++;}return true;}
iv.camera=function(d){if(d)this.load(d);}
iv.camera.prototype=new iv.object();iv.camera.prototype.load=function(d){for(var v in d){var a=d[v];switch(v){case 'from':
case 'up':
case 'to':this[v]=a.slice();break;default:this[v]=a;}}}
iv.camera.prototype.preRender=function(node,tm,space,state,opacity){return true;}
iv.mesh=function(gl){this.gl=gl;this.lineMode=false;}
iv.mesh.prototype=new iv.object();iv.mesh.prototype.setPoints=function(a,keep){this.setBuffer('v',iv.bufferF(this.gl,a,3));if(keep)this.points=a;}
iv.mesh.prototype.setUV=function(a,keep){this.setBuffer('uv',iv.bufferF(this.gl,a,2));if(keep)this.uvpoints=a;}
iv.mesh.prototype.setUV2=function(a,keep){this.setBuffer('uv2',iv.bufferF(this.gl,a,2));if(keep)this.uv2points=a;}
iv.mesh.prototype.setNormals=function(a,keep){this.setBuffer('n',iv.bufferF(this.gl,a,3));if(keep)this.normals=a;}
iv.mesh.prototype.setFaces=function(f,keep){this.setBuffer('f',iv.bufferI(this.gl,f));if(keep)this.faces=f;}
iv.mesh.prototype.setBuffer=function(n,b){n+='Buffer';var _b=this[n];if(_b){_b.ref--;if(_b.ref<1)this.gl.deleteBuffer(_b);}
this[n]=b;if(b){if(b.ref)b.ref++;else b.ref=1;}}
iv.mesh.prototype.addEdge=function(e,v1,v2){if(v2>v1){var _v=v2;v2=v1;v1=_v;}if(e[v1]==undefined)e[v1]=v2;else
if(typeof e[v1]==='number')e[v1]=[e[v1],v2];else e[v1].push(v2);};iv.mesh.prototype.updateEdges=function(){if(!this.edgeBuffer){var e=[];var f=this.faces;var nf=f.length/3;var j=0;var i;for(i=0;i<nf;i++){this.addEdge(e,f[j],f[j+1]);this.addEdge(e,f[j+1],f[j+2]);this.addEdge(e,f[j+2],f[j]);j+=3;}
var ne=e.length;var num=0;for(i=0;i<ne;i++){var v=e[i];if(v!=undefined){if(typeof v==='number')num++;else num+=v.length;}}
var edges=new Uint16Array(num*2);var j=0;for(i=0;i<ne;i++){var v=e[i];if(v!=undefined){if(typeof v==='number'){edges[j]=i;edges[j+1]=v;j+=2;}else
{for(var i1=0;i1<v.length;i1++){edges[j]=i;edges[j+1]=v[i1];j+=2;}}}}this.setBuffer('e',iv.bufferI(this.gl,edges));}}
iv.mesh.prototype.preRender=function(node,tm,space,state,opacity){if(this.url){var r=iv.createRequest(this.url);if(r){space.meshesInQueue++;r.ivobject=this;r.ivspace=space;iv.loadMesh(r);r.send();}delete this.url;}
else{if(state&4 && space.cfgSelZOffset)state|=0x20000;if(this.boxMin)space.toRenderQueue(tm,node,state,opacity);}}
iv.mesh.prototype.c1=function(space,mtl,info,oz){if(!mtl)mtl=info.mtl;var s=space.c2(mtl,info,oz);var gl=space.gl;var _i=s.attrs,c=_i.length;for(var i=0;i<c;i++){var v=_i[i];var b=null,f=gl.FLOAT,n=false;switch(v.id){case 4300: b=this.vBuffer;break;case 4301: b=this.nBuffer;break;case 4302: b=this.uvBuffer;break;case 4306: b=this.uv2Buffer;break;case 4303: b=this.bnBuffer;break;case 4304: b=this.btBuffer;break;case 4305: b=this.cBuffer;f=gl.UNSIGNED_BYTE;n=true;break;case 4307: b=this.ceBuffer;f=gl.UNSIGNED_BYTE;n=true;break;}if(b){gl.bindBuffer(gl.ARRAY_BUFFER,b);gl.vertexAttribPointer(v.slot,b.itemSize,f,n,0,0);}}}
iv.mesh.prototype.render=function(space,info){if(this.vBuffer){var state=info.state;var gl=space.gl,f,F=8;if(state&iv.R_Z_NOWRITE)gl.depthMask(false);var rmode=space.rmodes[(state&0xff00)>>8];if(rmode.e){f=F;var m=rmode.e;this.updateEdges(gl);if(this.edgeBuffer){f|=(state&(IV.R_Z_OFFSET));if(m.offest)f|=0x20000;if(this.nBuffer && m.n)f|=1;this.c1(space,m.mtl,info,f);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.edgeBuffer);gl.drawElements(gl.LINES,this.edgeBuffer.numItems,gl.UNSIGNED_SHORT,0);}}if(rmode.f){var m=rmode.f;var fb=this.fBuffer;if(fb){f=F;if(this.nBuffer && m.n)f|=1;if(this.uvBuffer)f|=2;if(this.uv2Buffer)f|=32;if(this.cBuffer)f|=4;if(this.ceBuffer)f|=64;if(this.bnBuffer)f|=16;if(state&iv.R_SELECTION)f|=256;if(state&32)f|=512;if(info.opacity<1.0)f|=1024;f|=(state&(iv.R_Z_OFFSET));this.c1(space,m.mtl,info,f);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,fb);var o=fb.offset;gl.drawElements(this.lineMode?gl.LINES:gl.TRIANGLES,fb.numItems,gl.UNSIGNED_SHORT,o?o:0);}}if(state&iv.R_Z_NOWRITE)gl.depthMask(true);}}
iv.bufferImp=function(gl,type,v,cmp,n){var b=gl.createBuffer();gl.bindBuffer(type,b);gl.bufferData(type,v,gl.STATIC_DRAW);b.itemSize=cmp;b.numItems=n;return b;}
iv.bufferF=function(gl,v,cmp){if((!(v instanceof Float32Array))&&(!(v instanceof Uint8Array)))v=new Float32Array(v);return iv.bufferImp(gl,gl.ARRAY_BUFFER,v,cmp,v.length/cmp);};iv.bufferI=function(gl,v){if(!(v instanceof Uint16Array))v=new Uint16Array(v);return iv.bufferImp(gl,gl.ELEMENT_ARRAY_BUFFER,v,1,v.length);}
iv.mesh.prototype.clear=function(){this.setBuffer('uv',null);this.setBuffer('uv2',null);this.setBuffer('f',null);this.setBuffer('v',null);this.setBuffer('n',null);this.setBuffer('e',null);this.setBuffer('c',null);this.setBuffer('ce',null);this.setBuffer('bn',null);this.setBuffer('bt',null);}
;iv.loadMesh=function(oi){oi.responseType="arraybuffer";oi.onreadystatechange=function(){if(this.readyState==4 && this.status==200){this.ivobject.load(this.ivspace,this.response);this.ivspace.onMeshLoaded(this.ivobject);}}}
;iv.bitStream=function(dv,dvpos){this.st=dv;this.stpos=dvpos;this.m_b=0;this.m_pos=0;};iv.bitStream.prototype.read=function(b){var r=0;while(b){if(!this.m_pos){this.m_b=this.st.getUint8(this.stpos++);this.m_pos=8;}
var t=b;if(t>this.m_pos)t=this.m_pos;r<<=t;r|=(this.m_b&0x0ff)>>(8-t);this.m_b<<=t;b-=t;this.m_pos-=t;}return r;}
iv.mesh.prototype.numBits=function(index){var i=0;while(index){index>>=1;i++;}return i;}
iv.mesh.prototype.ivdcmpf=function(cmp,v,c){var index=0,k=0,code=0;while(k<c){code=cmp.read(2);if(code==0){v[k]=index;index++;}else
{code<<=1;code|=cmp.read(1);if(code==4)v[k]=v[k-1]+1;else
if(code==5)v[k]=v[k-cmp.read(4)-2];else
if(code==6)v[k]=cmp.read(this.numBits(index));else
if(code==7){var sign=cmp.read(1);var delta=cmp.read(5);if(sign)delta*=-1;v[k]=v[k-1]+delta;}else
{var j=k-(cmp.read(code==2?4:13)+1);var _v1,_v2;if(j%3||(j>=(k-2))){_v1=j;_v2=j-1;}else{_v2=j+2;_v1=j;}
v[k]=v[_v1];v[k+1]=v[_v2];k++;}}
k++;}};iv.mesh.prototype.dcdnrml=function(d,i,n,j){var nx,ny,nz,k,l;var a=9.5875262183254544e-005*d.getUint16(i,true);var b=4.7937631091627272e-005*d.getUint16(i+2,true);k=Math.sin(b);nx=Math.cos(a)*k;ny=Math.sin(a)*k;nz=Math.cos(b);l=Math.sqrt(nx*nx+ny*ny+nz*nz);nx/=l;ny/=l;nz/=l;n[j]=nx;j++;n[j]=ny;j++;n[j]=nz;}
iv.mesh.prototype.copyn=function(v,_n,i,j){i*=3;j*=3;v[i]=_n[j];v[i+1]=_n[j+1];v[i+2]=_n[j+2];};iv.mesh.prototype.copyn_i=function(v,_n,i,j){i*=3;j*=3;v[i]=-_n[j];v[i+1]=-_n[j+1];v[i+2]=-_n[j+2];};iv.mesh.prototype.readCmp=function(a,b,count,c,s,pos,box){var min=a.getFloat32(pos+c*4,true);var dx=a.getFloat32(pos+c*4+s*4,true);if(box){this.boxMin[c]=min;this.boxMax[c]=min+dx*65535;}
pos+=s*8+c*2;for(var i=0;i<count;i++){b[c]=dx*a.getUint16(pos,true)+min;pos+=s*2;c+=s;}}
iv.mesh.prototype.load=function(space,buffer){var gl=space.gl;var data=new DataView(buffer);var oh=data.getUint16(0,true);var nF=data.getUint16(2,true);var flags=data.getUint16(4,true);var offset=30+oh*6;var n3=oh*3;if(flags&8){this.lineMode=true;nF*=2;}else nF*=3;var v=new Float32Array(n3);var index=0,i;var f=new Uint16Array(nF);if(flags&256){var bs=new iv.bitStream(data,offset);this.ivdcmpf(bs,f,nF);offset=bs.stpos;}else{if(flags&4){for(i=0;i<nF;i++)f[i]=data.getUint8(offset++);}else
{for(i=0;i<nF;i++){f[i]=data.getUint16(offset,true);offset+=2;}}}this.setFaces(f,(space.cfgKeepMeshData&1));if(flags&16){var cs=data.getUint16(offset,true);offset+=2;var n;if(this.bump)n=new Float32Array(n3);else n=v;if(cs){var _n=new Float32Array(cs*3);for(i=0;i<cs;i++){this.dcdnrml(data,offset,_n,i*3);offset+=4;}
var bs=new iv.bitStream(data,offset);i=0;var j=0,ibits=0;while(i<oh){var cd=bs.read(1);if(cd){cd=bs.read(1);if(ibits)index=bs.read(ibits);else index=0;if(cd)this.copyn(n,_n,i,index);else this.copyn_i(n,_n,i,index);}else
{ibits=this.numBits(j);this.copyn(n,_n,i,j);j++;}
i++;}
offset=bs.stpos;}else{for(i=0;i<oh;i++){this.dcdnrml(data,offset,n,i*3);offset+=4;}}this.setNormals(n);}this.boxMin=[];this.boxMax=[];this.readCmp(data,v,oh,0,3,6,true);this.readCmp(data,v,oh,1,3,6,true);this.readCmp(data,v,oh,2,3,6,true);this.setPoints(v,space.cfgKeepMeshData&2);}
;iv.initViewer3d=function(file,bk,path,size){var canvas=document.getElementById("ivwindow3d");var v=new iv.window({canvas:canvas,color:bk});iv.uiScale=size;v.rmodes=[
{"f":true,"n":true,"e":false,"mtl":null},{"f":false,"n":true,"e":true,"mtl":null},];var divP=document.createElement("div");divP.className="dprogress";var d=document.createElement("div"),c=null;d.innerHTML='<svg id="progress" class="cprogress" width="100" height="100" viewPort="0 0 50 50" version="1.1" xmlns="http://www.w3.org/2000/svg"><circle id="bar" r="45" cx="50" cy="50" fill="transparent" stroke-dasharray="282.743" stroke-dashoffset="0" transform="rotate(-90 50 50)"></circle></svg>';c=iv.getSubElementById(d,"progress");if(c && c.children)c=c.children[0];divP.appendChild(d);var div2=document.createElement("div");div2.className="tprogress";var text=document.createElement("div");text.className="textProgress";text.innerHTML="0%";div2.appendChild(text);divP.appendChild(div2);canvas.parentElement.appendChild(divP);v.progress={circle:c,text:text,div:d?d.parentElement:null};window.onresize=function(){v.setViewSize(window.innerWidth,window.innerHeight);iv.udpateMenu(v);return v;}
v.setViewSize=function(w,h){iv.window.prototype.setViewSize.call(this,w,h);var s=this.progress.div.style;s.left=(w-100)/2+'px';s.top=(h-100)/2+'px';}
v.progress.div.style.display="inline-block";v.addRefTarget(function(a){switch(a.code){case "dataReady":v.progress.div.style.display="none";break;case "progress":
var i=a.loaded/a.total;if(v.progress.circle)v.progress.circle.style.strokeDashoffset=45*Math.PI*2.0*(1.0-i);v.progress.text.innerHTML=Math.round(i*100).toString()+"%";break;case "selection":{v.treeView.onNodeSelected(a.node);break;}}});v.setViewSize(window.innerWidth,window.innerHeight);v.load(file||"tree.iv3d",path);return v;}
iv.getSubElementById=function(dNode,id){var dResult=null;if(dNode.getAttribute('id')==id)return dNode;for(var i=0;i<dNode.childNodes.length;i++){if(dNode.childNodes[i].nodeType==1){dResult=iv.getSubElementById(dNode.childNodes[i],id);if(dResult !=null)break;}}return dResult;}
